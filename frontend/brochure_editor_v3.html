<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brochure Editor - Professional Review Mode</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="brochure_editor_v3.css?v=20251231_CANVA_EDIT">
    <link rel="stylesheet" href="social_media_repurpose.css?v=20251028_SECTION1">
    <link rel="stylesheet" href="extended_features.css?v=20260115_CANVA2">
    <link rel="stylesheet" href="template_mega_library.css?v=20260115_MEGA">
</head>
<body>
    <!-- Header Bar -->
    <header class="editor-header">
        <div class="header-left">
            <button id="backBtn" class="icon-btn" title="Back to Builder">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>
            <h1 class="editor-title">Brochure Editor</h1>
            <span id="propertyAddress" class="property-label"></span>
        </div>
        <div class="header-center">
            <div class="status-indicator">
                <span id="statusDot" class="status-dot"></span>
                <span id="statusText" class="status-text">Loading session...</span>
            </div>
        </div>
        <div class="header-right">
            <!-- Undo/Redo Buttons -->
            <div class="undo-redo-group">
                <button id="undoBtn" class="action-btn icon-only" title="Undo (Ctrl+Z)" disabled onclick="undo()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 7v6h6"/>
                        <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/>
                    </svg>
                </button>
                <button id="redoBtn" class="action-btn icon-only" title="Redo (Ctrl+Y)" disabled onclick="redo()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 7v6h-6"/>
                        <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"/>
                    </svg>
                </button>
                <button id="versionHistoryBtn" class="action-btn icon-only" title="Version History" onclick="openVersionHistory()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                </button>
                <button id="keyboardShortcutsBtn" class="action-btn icon-only" title="Keyboard Shortcuts (?)" onclick="openKeyboardShortcuts()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="4" width="20" height="16" rx="2"/>
                        <path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01"/>
                        <path d="M6 12h.01M10 12h.01M14 12h.01M18 12h.01"/>
                        <path d="M8 16h8"/>
                    </svg>
                </button>
            </div>

            <button id="toggleChatbotBtn" class="action-btn" title="Transform Text">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    <line x1="9" y1="10" x2="15" y2="10"></line>
                    <line x1="12" y1="7" x2="12" y2="13"></line>
                </svg>
                AI Transform
            </button>
            <button id="saveBtn" class="action-btn" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                </svg>
                Save
            </button>
            <button id="exportBtn" class="action-btn primary" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export PDF
            </button>
            <button id="repurposeBtn" class="action-btn secondary" disabled style="background: linear-gradient(135deg, #0066FF 0%, #00CCFF 100%); border: none; color: white;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 1l4 4-4 4"/>
                    <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                    <path d="M7 23l-4-4 4-4"/>
                    <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                </svg>
                Repurpose
            </button>
        </div>
    </header>

    <!-- Floating Image Tools Toolbar -->
    <div id="imageToolsToolbar" class="image-tools-toolbar" style="display: none;">
        <button class="format-btn" id="bgRemovalBtn" title="Remove Background" onclick="openBackgroundRemoval()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke-dasharray="4"/>
                <path d="M12 8v8M8 12h8"/>
            </svg>
            <span>Remove BG</span>
        </button>
        <button class="format-btn" id="photoEffectsBtn" title="Photo Effects & Filters (40+)" onclick="openPhotoEffects()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
            </svg>
            <span>Filters</span>
        </button>
        <button class="format-btn" id="cropImageBtn" title="Crop Image" onclick="openImageCrop()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6.13 1L6 16a2 2 0 0 0 2 2h15"/>
                <path d="M1 6.13L16 6a2 2 0 0 1 2 2v15"/>
            </svg>
            <span>Crop</span>
        </button>
        <button class="format-btn" id="flipImageBtn" title="Flip Image" onclick="flipSelectedImage()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3"/>
                <path d="M16 3h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-3"/>
                <line x1="12" y1="3" x2="12" y2="21"/>
            </svg>
            <span>Flip</span>
        </button>
    </div>

    <!-- Floating Text Formatting Toolbar -->
    <div id="textFormatToolbar" class="text-format-toolbar" style="display: none;">
        <!-- Bold/Italic/Underline -->
        <button class="format-btn" data-command="bold" title="Bold (Ctrl+B)">
            <strong>B</strong>
        </button>
        <button class="format-btn" data-command="italic" title="Italic (Ctrl+I)">
            <em>I</em>
        </button>
        <button class="format-btn" data-command="underline" title="Underline (Ctrl+U)">
            <u>U</u>
        </button>
        <div class="toolbar-divider"></div>

        <!-- Text Color Picker -->
        <div class="color-picker-wrapper" title="Text Color">
            <button class="format-btn color-btn" id="textColorBtn">
                <span style="font-weight: bold;">A</span>
                <div class="color-indicator" id="textColorIndicator" style="background: #000000;"></div>
            </button>
            <input type="color" id="textColorInput" value="#000000" style="display: none;">
        </div>

        <!-- Highlight Color Picker -->
        <div class="color-picker-wrapper" title="Highlight Color">
            <button class="format-btn color-btn" id="highlightColorBtn">
                <span style="background: yellow; padding: 0 4px;">A</span>
                <div class="color-indicator" id="highlightColorIndicator" style="background: transparent; border: 1px dashed #ccc;"></div>
            </button>
            <input type="color" id="highlightColorInput" value="#FFFF00" style="display: none;">
        </div>
        <div class="toolbar-divider"></div>

        <!-- Text Alignment -->
        <button class="format-btn" data-command="justifyLeft" title="Align Left">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v2H3V3zm0 4h12v2H3V7zm0 4h18v2H3v-2zm0 4h12v2H3v-2zm0 4h18v2H3v-2z"/></svg>
        </button>
        <button class="format-btn" data-command="justifyCenter" title="Align Center">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v2H3V3zm3 4h12v2H6V7zm-3 4h18v2H3v-2zm3 4h12v2H6v-2zm-3 4h18v2H3v-2z"/></svg>
        </button>
        <button class="format-btn" data-command="justifyRight" title="Align Right">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v2H3V3zm6 4h12v2H9V7zm-6 4h18v2H3v-2zm6 4h12v2H9v-2zm-6 4h18v2H3v-2z"/></svg>
        </button>
        <div class="toolbar-divider"></div>

        <!-- Font Size -->
        <select class="format-select" id="fontSizeSelect" title="Font Size">
            <option value="12px">12</option>
            <option value="14px">14</option>
            <option value="16px" selected>16</option>
            <option value="18px">18</option>
            <option value="20px">20</option>
            <option value="24px">24</option>
            <option value="28px">28</option>
            <option value="32px">32</option>
            <option value="36px">36</option>
            <option value="48px">48</option>
            <option value="64px">64</option>
        </select>

        <!-- Font Family -->
        <select class="format-select" id="fontFamilySelect" title="Font Family" style="max-width: 140px;">
            <optgroup label="Estate Agent Favorites">
                <option value="'Playfair Display', serif">Playfair Display</option>
                <option value="'Montserrat', sans-serif">Montserrat</option>
                <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
                <option value="'Raleway', sans-serif">Raleway</option>
                <option value="'Lora', serif">Lora</option>
            </optgroup>
            <optgroup label="Display & Serif">
                <option value="'Libre Baskerville', serif">Libre Baskerville</option>
                <option value="'Merriweather', serif">Merriweather</option>
                <option value="'Source Serif Pro', serif">Source Serif Pro</option>
                <option value="'EB Garamond', serif">EB Garamond</option>
                <option value="'PT Serif', serif">PT Serif</option>
            </optgroup>
            <optgroup label="Modern Sans-Serif">
                <option value="'Inter', sans-serif">Inter</option>
                <option value="'Poppins', sans-serif">Poppins</option>
                <option value="'Open Sans', sans-serif">Open Sans</option>
                <option value="'Roboto', sans-serif">Roboto</option>
                <option value="'Lato', sans-serif">Lato</option>
                <option value="'Nunito', sans-serif">Nunito</option>
                <option value="'Work Sans', sans-serif">Work Sans</option>
                <option value="'DM Sans', sans-serif">DM Sans</option>
            </optgroup>
            <optgroup label="Condensed">
                <option value="'Oswald', sans-serif">Oswald</option>
                <option value="'Roboto Condensed', sans-serif">Roboto Condensed</option>
                <option value="'Barlow Condensed', sans-serif">Barlow Condensed</option>
            </optgroup>
            <optgroup label="Handwriting">
                <option value="'Dancing Script', cursive">Dancing Script</option>
                <option value="'Pacifico', cursive">Pacifico</option>
                <option value="'Great Vibes', cursive">Great Vibes</option>
            </optgroup>
        </select>
        <!-- Advanced Font Picker Button -->
        <button class="format-btn" id="advancedFontsBtn" title="Browse 47+ Fonts" onclick="openAdvancedFontPicker()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 7V4h16v3"/>
                <path d="M9 20h6"/>
                <path d="M12 4v16"/>
            </svg>
        </button>
        <div class="toolbar-divider"></div>

        <!-- Line Height -->
        <div class="spacing-control" title="Line Height">
            <label>LH</label>
            <input type="range" id="lineHeightSlider" min="1" max="2.5" step="0.1" value="1.5"
                   oninput="setTextLineHeight(this.value)">
            <span id="lineHeightValue">1.5</span>
        </div>

        <!-- Letter Spacing -->
        <div class="spacing-control" title="Letter Spacing">
            <label>LS</label>
            <input type="range" id="letterSpacingSlider" min="-2" max="10" step="0.5" value="0"
                   oninput="setTextLetterSpacing(this.value)">
            <span id="letterSpacingValue">0px</span>
        </div>
        <div class="toolbar-divider"></div>

        <!-- Curved Text Button -->
        <button class="format-btn" id="curvedTextBtn" title="Curved Text (11 presets)" onclick="openCurvedTextPanel()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 12C2 6.5 6.5 2 12 2s10 4.5 10 10"/>
                <text x="7" y="18" font-size="8" fill="currentColor">Aa</text>
            </svg>
        </button>

        <!-- Text Animations Button -->
        <button class="format-btn" id="textAnimationsBtn" title="Text Animations (22 effects)" onclick="openTextAnimationsPanel()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
        </button>
    </div>

    <!-- Main Content Area -->
    <main class="editor-main">
        <!-- Sidebar - Page List -->
        <aside class="pages-sidebar">
            <div class="sidebar-header">
                <h2>Pages</h2>
                <span id="pageCount" class="page-count">0 pages</span>
            </div>
            <div id="pageList" class="page-list">
                <!-- Pages will be dynamically inserted here -->
            </div>
            <div class="sidebar-actions">
                <button id="addPageBtn" class="add-page-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Page
                </button>
                <button id="duplicatePageBtn" class="duplicate-page-btn" onclick="duplicateCurrentPage()" title="Duplicate current page">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    Duplicate
                </button>
            </div>
        </aside>

        <!-- Photo Gallery Sidebar -->
        <aside class="photo-gallery-sidebar">
            <div class="sidebar-header">
                <h2>Photo Gallery</h2>
                <span id="photoCount" class="photo-count">0 photos</span>
            </div>
            <div class="upload-area" id="imageUploadArea">
                <input type="file" id="imageUploadInput" accept="image/*" multiple hidden>
                <div class="upload-prompt" onclick="document.getElementById('imageUploadInput').click()">
                    <span class="upload-icon">üì∑</span>
                    <span class="upload-text">Click to upload or drag images</span>
                </div>
            </div>
            <div class="stock-photos-btn-wrapper" style="padding: 8px;">
                <button id="stockPhotosBtn" class="action-btn secondary" onclick="openStockPhotos()" style="width: 100%; font-size: 13px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                    Free Stock Photos
                </button>
            </div>
            <div id="photoGalleryList" class="photo-gallery-list">
                <!-- Photos will be dynamically inserted here -->
            </div>
        </aside>

        <!-- Canvas Area - Brochure Preview -->
        <section class="canvas-area">
            <div class="canvas-toolbar">
                <div class="zoom-controls">
                    <button id="zoomOutBtn" class="tool-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            <line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                    <span id="zoomLevel" class="zoom-label">65%</span>
                    <button id="zoomInBtn" class="tool-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            <line x1="11" y1="8" x2="11" y2="14"/>
                            <line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                    <button id="fitToWidthBtn" class="tool-btn">Fit to Width</button>
                </div>
                <div class="view-mode">
                    <label>
                        <input type="checkbox" id="showGuidesToggle">
                        Show Guides
                    </label>
                </div>
                <div class="template-selector">
                    <button id="openTemplatesBtn" class="tool-btn primary" title="Choose Design Template">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        Templates
                    </button>
                </div>
            </div>

            <div class="canvas-container" id="canvasContainer">
                <div class="canvas-scroll">
                    <div id="brochureCanvas" class="brochure-canvas">
                        <!-- Brochure pages will be rendered here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Right Panel Tabs Container -->
        <aside class="right-panels-container">
            <!-- Panel Tabs -->
            <div class="panel-tabs">
                <button class="panel-tab" data-panel="layouts">Layouts</button>
                <button class="panel-tab" data-panel="templates">Templates</button>
                <button class="panel-tab active" data-panel="elements">Elements</button>
                <button class="panel-tab" data-panel="effects">Effects</button>
                <button class="panel-tab" data-panel="layers">Layers</button>
            </div>

            <!-- Layout Picker Panel -->
            <div id="layoutsPanel" class="tab-panel">
                <div id="layoutPickerContent" class="layout-picker-content">
                    <!-- Layout previews will be dynamically inserted here -->
                </div>
            </div>

            <!-- Templates Panel -->
            <div id="templatesPanel" class="tab-panel">
                <div id="templatePickerContent">
                    <!-- Will be populated by template picker -->
                </div>
            </div>

            <!-- Elements Library Panel -->
            <div id="elementsPanel" class="tab-panel active">
                <!-- Elements Library Content (shapes, icons, QR) -->
                <div id="elementsLibraryContent">
                    <!-- Will be populated by elements_library.js -->
                </div>

                <!-- Pre-built Sections -->
                <div id="prebuiltSectionsContainer">
                    <!-- Will be populated by prebuilt_sections.js -->
                </div>

                <!-- Text Effects Panel (shows when text selected) -->
                <div id="textEffectsPanelContainer">
                    <!-- Will be populated by text_effects.js -->
                </div>
            </div>

            <!-- Visual Effects Panel -->
            <div id="effectsPanel" class="tab-panel">
                <div id="visualEffectsContent">
                    <!-- Will be populated by visual_effects.js -->
                </div>
            </div>

            <!-- Layers Panel -->
            <div id="layerPanel" class="tab-panel">
                <!-- Will be populated by layer_system.js -->
            </div>

            <!-- Alignment Toolbar (always visible) -->
            <div id="alignmentToolbar" class="alignment-toolbar">
                <!-- Will be populated by alignment_system.js -->
            </div>
        </aside>

        <!-- Text Transformation Chatbot Panel -->
        <aside id="chatbotPanel" class="chatbot-panel" style="display: none;">
            <div class="panel-header">
                <h2>Transform Text</h2>
                <button id="closeChatbotBtn" class="close-panel-btn" title="Close">&times;</button>
            </div>
            <div class="chatbot-content">
                <div class="chatbot-info">
                    <div class="current-page-info">
                        <span class="info-label">Current Page:</span>
                        <span id="chatbotPageTitle" class="info-value"></span>
                    </div>
                    <div class="word-count-info">
                        <span class="info-label">Word Count:</span>
                        <span id="chatbotWordCount" class="info-value">0 words</span>
                    </div>
                </div>

                <div class="transformation-styles">
                    <h3>Quick Transforms</h3>
                    <div class="style-buttons">
                        <button class="style-btn" data-style="bullet_points">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                            </svg>
                            <span>Bullet Points</span>
                        </button>
                        <button class="style-btn" data-style="key_features">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>
                            <span>Key Features</span>
                        </button>
                        <button class="style-btn" data-style="concise">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                            </svg>
                            <span>Make Concise</span>
                        </button>
                        <button class="style-btn" data-style="elaborate">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 20h9"></path>
                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                            </svg>
                            <span>Elaborate</span>
                        </button>
                        <button class="style-btn" data-style="professional">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                            </svg>
                            <span>Professional</span>
                        </button>
                        <button class="style-btn" data-style="friendly">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                <line x1="15" y1="9" x2="15.01" y2="9"></line>
                            </svg>
                            <span>Friendly</span>
                        </button>
                    </div>
                </div>

                <div class="custom-transformation">
                    <h3>Custom Instruction</h3>
                    <textarea id="customInstruction" placeholder="Enter custom instructions for transformation..." rows="3"></textarea>
                    <button id="customTransformBtn" class="action-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Transform with Custom Instruction
                    </button>
                </div>
            </div>
        </aside>

        <!-- Design Templates Panel (Overlay) -->
        <aside id="templatesPanelOverlay" class="templates-panel">
            <div class="panel-header">
                <h2>üé® Design Templates</h2>
                <button id="closeTemplatesBtn" class="close-panel-btn" title="Close">&times;</button>
            </div>
            <div class="templates-content">
                <div class="templates-info">
                    <p>Choose a design template to instantly transform your brochure's appearance with professional color schemes, borders, and accents.</p>
                </div>

                <!-- Free Templates -->
                <div class="template-section">
                    <h3>‚ú® Free Templates</h3>
                    <div class="template-grid" id="freeTemplatesGrid">
                        <!-- Generated dynamically -->
                    </div>
                </div>

                <!-- Premium Templates -->
                <div class="template-section">
                    <h3>üëë Premium Templates</h3>
                    <p class="premium-note">Unlock premium templates for more sophisticated designs</p>
                    <div class="template-grid premium-grid" id="premiumTemplatesGrid">
                        <!-- Generated dynamically -->
                    </div>
                </div>

                <!-- Reset Option -->
                <button id="resetTemplateBtn" class="action-btn secondary" style="margin-top: 20px; width: 100%;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="1 4 1 10 7 10"></polyline>
                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                    </svg>
                    Reset to Default
                </button>
            </div>
        </aside>
    </main>

    <!-- Text Transformation Preview Modal -->
    <div id="transformPreviewModal" class="modal" style="display: none;">
        <div class="modal-content transform-preview">
            <div class="modal-header">
                <h3>Preview Text Transformation</h3>
                <button class="modal-close" id="closePreviewBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="preview-info">
                    <span class="preview-message" id="previewMessage"></span>
                </div>
                <div class="comparison-view">
                    <div class="text-column">
                        <h4>Current Text</h4>
                        <div class="text-preview original" id="originalTextPreview"></div>
                        <div class="text-stats">
                            <span id="originalWordCount">0 words</span>
                            <span id="originalCharCount">0 characters</span>
                        </div>
                    </div>
                    <div class="arrow-divider">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                            <polyline points="12 5 19 12 12 19"></polyline>
                        </svg>
                    </div>
                    <div class="text-column">
                        <h4>Transformed Text</h4>
                        <div class="text-preview transformed" id="transformedTextPreview"></div>
                        <div class="text-stats">
                            <span id="transformedWordCount">0 words</span>
                            <span id="transformedCharCount">0 characters</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelTransformBtn" class="btn secondary">Cancel</button>
                <button id="applyTransformBtn" class="btn primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Apply Transformation
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay with Progress -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-modal">
            <div class="loading-header">
                <div class="spinner"></div>
                <h2>Preparing Your Brochure</h2>
                <p class="loading-subtitle">Our AI is crafting bespoke descriptions for each space</p>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <span id="progressText" class="progress-text">0%</span>
            </div>

            <button id="skipGenerationBtn" class="skip-generation-btn" onclick="skipAIGeneration()">
                Skip & Load Now (Use Default Text)
            </button>

            <div id="loadingSteps" class="loading-steps">
                <div class="step" data-step="session">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Loading session data...</span>
                </div>
                <div class="step" data-step="kitchen">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Generating kitchen description...</span>
                </div>
                <div class="step" data-step="living">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Generating living spaces description...</span>
                </div>
                <div class="step" data-step="bedrooms">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Generating bedrooms description...</span>
                </div>
                <div class="step" data-step="bathrooms">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Generating bathrooms description...</span>
                </div>
                <div class="step" data-step="garden">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Generating outdoor spaces description...</span>
                </div>
                <div class="step" data-step="location">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Generating location description...</span>
                </div>
                <div class="step" data-step="rendering">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Rendering brochure pages...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content error">
            <div class="modal-header">
                <h3>Error</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="errorMessage"></p>
            </div>
            <div class="modal-footer">
                <button id="errorRetryBtn" class="btn">Retry</button>
                <button id="errorBackBtn" class="btn secondary">Back to Builder</button>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="toast success">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span id="toastMessage"></span>
    </div>

    <script src="unified_brochure_builder.js?v=20251231_AUTOGEN"></script>
    <script src="brochure_editor_v3.js?v=20251231_CANVA_PREMIUM2"></script>
    <script src="brochure_editor_chatbot.js?v=20251020_FINAL"></script>
    <script src="image_editor.js?v=20251231_CANVA_EDIT"></script>
    <script src="photo_gallery_manager.js?v=20251020_CLEAN_TEMPLATES"></script>
    <script src="post_export_system.js?v=20251020_ADVANCED_AI"></script>
    <script src="brochure_templates.js?v=20251020_TEMPLATE_DEBUG"></script>
    <script src="social_media_repurpose.js?v=20251028_SECTION1"></script>
    <script>
        // Initialize templates panel (overlay)
        document.addEventListener('DOMContentLoaded', () => {
            const templatesPanel = document.getElementById('templatesPanelOverlay');
            const openTemplatesBtn = document.getElementById('openTemplatesBtn');
            const closeTemplatesBtn = document.getElementById('closeTemplatesBtn');
            const resetTemplateBtn = document.getElementById('resetTemplateBtn');

            if (!openTemplatesBtn || !templatesPanel) {
                console.error('Templates panel elements not found!');
                return;
            }

            // Open/close panel
            openTemplatesBtn.addEventListener('click', () => {
                console.log('üé® Templates button clicked!');
                console.log('BrochureTemplates available?', !!window.BrochureTemplates);
                console.log('getAvailableTemplates available?', !!window.getAvailableTemplates);

                if (!window.BrochureTemplates) {
                    console.error('‚ùå BrochureTemplates not loaded!');
                    alert('Error: Templates not loaded. Please refresh the page.');
                    return;
                }

                console.log('Free templates:', window.BrochureTemplates.free);
                console.log('Free templates count:', Object.keys(window.BrochureTemplates.free).length);

                templatesPanel.classList.add('active');
                templatesPanel.style.display = 'flex';
                initializeTemplates();
            });

            closeTemplatesBtn.addEventListener('click', () => {
                templatesPanel.classList.remove('active');
            });

            // Reset template
            resetTemplateBtn.addEventListener('click', () => {
                window.applyTemplateToAll('savills_classic');
                alert('Reset to Savills Classic template');
            });

            // Initialize templates when panel opens
            function initializeTemplates() {
                const hasPremium = false; // TODO: Check user's subscription
                populateTemplates(hasPremium);
            }

            // Populate template grids
            function populateTemplates(hasPremium) {
                try {
                    const freeGrid = document.getElementById('freeTemplatesGrid');
                    const premiumGrid = document.getElementById('premiumTemplatesGrid');

                    console.log('üìã Populating templates...');
                    console.log('Free grid element:', freeGrid);
                    console.log('Premium grid element:', premiumGrid);

                    if (!freeGrid || !premiumGrid) {
                        console.error('‚ùå Grid elements not found!');
                        return;
                    }

                    // Clear existing
                    freeGrid.innerHTML = '';
                    premiumGrid.innerHTML = '';

                    // Get templates
                    if (!window.getAvailableTemplates) {
                        console.error('‚ùå getAvailableTemplates function not available!');
                        return;
                    }

                    const templates = window.getAvailableTemplates(hasPremium);
                    console.log('Available templates:', templates);
                    console.log('Number of templates:', templates.length);

                    // Separate free and premium
                    const freeTemplates = templates.filter(t => t.tier === 'free');
                    const premiumTemplates = Object.values(window.BrochureTemplates.premium || {});

                    console.log('Free templates to render:', freeTemplates.length);
                    console.log('Premium templates to render:', premiumTemplates.length);

                    // Render free templates
                    freeTemplates.forEach((template, index) => {
                        console.log(`Creating card ${index + 1}:`, template.name);
                        const card = createTemplateCard(template, true);
                        freeGrid.appendChild(card);
                        console.log(`‚úÖ Card ${index + 1} appended to grid`);
                    });

                    console.log('Final freeGrid children count:', freeGrid.children.length);

                    // Render premium templates (if any)
                    if (premiumTemplates.length > 0) {
                        premiumTemplates.forEach(template => {
                            const card = createTemplateCard(template, hasPremium);
                            premiumGrid.appendChild(card);
                        });
                    } else {
                        // Hide premium section if empty
                        const premiumSection = premiumGrid.closest('.template-section');
                        if (premiumSection) {
                            premiumSection.style.display = 'none';
                            console.log('‚úÖ Premium section hidden (no premium templates)');
                        }
                    }

                    console.log('‚úÖ Templates populated successfully!');
                } catch (error) {
                    console.error('‚ùå Error populating templates:', error);
                }
            }

            // Create template card element
            function createTemplateCard(template, isUnlocked) {
                const card = document.createElement('div');
                card.className = 'template-card' + (isUnlocked ? ' unlocked' : '');
                card.dataset.templateId = template.id;

                // Check if this template is active
                const currentTemplate = (window.EditorState && window.EditorState.activeTemplate) || 'savills_classic';
                if (template.id === currentTemplate) {
                    card.classList.add('active');
                }

                card.innerHTML = `
                    <div class="template-card-header">
                        <div class="template-preview">${template.preview}</div>
                        <div class="template-info">
                            <div class="template-name">${template.name}</div>
                            <span class="template-tier ${template.tier}">${template.tier}</span>
                        </div>
                    </div>
                    <div class="template-description">${template.description}</div>
                `;

                // Click handler
                if (isUnlocked) {
                    card.addEventListener('click', () => {
                        // Remove active class from all cards
                        document.querySelectorAll('.template-card').forEach(c => c.classList.remove('active'));
                        card.classList.add('active');

                        // Apply template
                        window.applyTemplateToAll(template.id);

                        // Show success message
                        console.log(`‚úÖ Applied template: ${template.name}`);
                    });
                } else {
                    card.addEventListener('click', () => {
                        alert('üîí This is a premium template. Upgrade to unlock premium designs!');
                    });
                }

                return card;
            }
        });

        // ====================================================================
        // TEXT FORMATTING TOOLBAR
        // ====================================================================
        const formatToolbar = document.getElementById('textFormatToolbar');
        let activeTextElement = null;

        // Show toolbar when clicking on editable text
        document.addEventListener('click', (e) => {
            const editable = e.target.closest('[contenteditable="true"]');

            if (editable) {
                activeTextElement = editable;
                showToolbar(e.clientX, e.clientY);
                updateToolbarState(editable);
            } else if (!formatToolbar.contains(e.target)) {
                hideToolbar();
            }
        });

        function showToolbar(x, y) {
            formatToolbar.style.display = 'flex';
            formatToolbar.style.left = `${x}px`;
            formatToolbar.style.top = `${y - 50}px`; // Position above click
        }

        function hideToolbar() {
            formatToolbar.style.display = 'none';
            activeTextElement = null;
        }

        function updateToolbarState(element) {
            // Update button active states
            document.querySelectorAll('.format-btn').forEach(btn => {
                const command = btn.dataset.command;
                const isActive = document.queryCommandState(command);
                btn.classList.toggle('active', isActive);
            });

            // Update font size dropdown
            const fontSize = window.getComputedStyle(element).fontSize;
            document.getElementById('fontSizeSelect').value = fontSize;

            // Update font family dropdown
            const fontFamily = window.getComputedStyle(element).fontFamily;
            document.getElementById('fontFamilySelect').value = fontFamily;
        }

        // Handle format button clicks
        document.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const command = btn.dataset.command;
                document.execCommand(command, false, null);
                btn.classList.toggle('active');
                if (activeTextElement) {
                    activeTextElement.focus();
                }
            });
        });

        // Handle font size change
        document.getElementById('fontSizeSelect').addEventListener('change', (e) => {
            if (activeTextElement) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.style.fontSize = e.target.value;
                    range.surroundContents(span);
                } else {
                    activeTextElement.style.fontSize = e.target.value;
                }
                activeTextElement.focus();
            }
        });

        // Handle font family change
        document.getElementById('fontFamilySelect').addEventListener('change', (e) => {
            if (activeTextElement) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.style.fontFamily = e.target.value;
                    range.surroundContents(span);
                } else {
                    activeTextElement.style.fontFamily = e.target.value;
                }
                activeTextElement.focus();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (!activeTextElement) return;

            if (e.ctrlKey || e.metaKey) {
                switch(e.key.toLowerCase()) {
                    case 'b':
                        e.preventDefault();
                        document.execCommand('bold');
                        break;
                    case 'i':
                        e.preventDefault();
                        document.execCommand('italic');
                        break;
                    case 'u':
                        e.preventDefault();
                        document.execCommand('underline');
                        break;
                }
            }
        });

        // ====================================================================
        // TEXT COLOR PICKER
        // ====================================================================
        const textColorBtn = document.getElementById('textColorBtn');
        const textColorInput = document.getElementById('textColorInput');
        const textColorIndicator = document.getElementById('textColorIndicator');
        const highlightColorBtn = document.getElementById('highlightColorBtn');
        const highlightColorInput = document.getElementById('highlightColorInput');
        const highlightColorIndicator = document.getElementById('highlightColorIndicator');

        // Color presets
        const colorPresets = [
            '#000000', '#374151', '#6B7280', '#9CA3AF', '#D1D5DB', '#FFFFFF',
            '#C20430', '#DC2626', '#EA580C', '#F59E0B', '#84CC16', '#22C55E',
            '#14B8A6', '#0EA5E9', '#3B82F6', '#6366F1', '#8B5CF6', '#A855F7',
            '#D946EF', '#EC4899', '#F43F5E', '#78350F', '#1E3A8A', '#064E3B'
        ];

        // Create color swatches dropdown
        function createColorSwatches(targetBtn, onColorSelect, showClear = false) {
            const existing = targetBtn.parentElement.querySelector('.color-swatches');
            if (existing) {
                existing.classList.toggle('visible');
                return;
            }

            const dropdown = document.createElement('div');
            dropdown.className = 'color-swatches visible';
            dropdown.innerHTML = `
                <div class="color-swatches-grid">
                    ${colorPresets.map(color => `
                        <div class="color-swatch" data-color="${color}" style="background: ${color};"></div>
                    `).join('')}
                </div>
                <div class="color-custom-input">
                    <label>Custom:</label>
                    <input type="color" value="#000000">
                    <input type="text" placeholder="#000000" maxlength="7">
                </div>
                ${showClear ? '<button class="color-clear-btn">Remove Highlight</button>' : ''}
            `;

            targetBtn.parentElement.appendChild(dropdown);

            // Handle swatch clicks
            dropdown.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', () => {
                    const color = swatch.dataset.color;
                    onColorSelect(color);
                    dropdown.classList.remove('visible');
                });
            });

            // Handle custom color input
            const customColorInput = dropdown.querySelector('input[type="color"]');
            const customTextInput = dropdown.querySelector('input[type="text"]');

            customColorInput.addEventListener('input', (e) => {
                customTextInput.value = e.target.value;
                onColorSelect(e.target.value);
            });

            customTextInput.addEventListener('change', (e) => {
                let val = e.target.value;
                if (!val.startsWith('#')) val = '#' + val;
                if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
                    customColorInput.value = val;
                    onColorSelect(val);
                }
            });

            // Handle clear button
            if (showClear) {
                dropdown.querySelector('.color-clear-btn').addEventListener('click', () => {
                    onColorSelect('transparent');
                    dropdown.classList.remove('visible');
                });
            }

            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && !targetBtn.contains(e.target)) {
                        dropdown.classList.remove('visible');
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 10);
        }

        // Text color button click
        textColorBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            createColorSwatches(textColorBtn, (color) => {
                if (activeTextElement) {
                    document.execCommand('foreColor', false, color);
                    textColorIndicator.style.background = color;
                    activeTextElement.focus();
                }
            });
        });

        // Highlight color button click
        highlightColorBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            createColorSwatches(highlightColorBtn, (color) => {
                if (activeTextElement) {
                    if (color === 'transparent') {
                        document.execCommand('removeFormat', false, null);
                        highlightColorIndicator.style.background = 'transparent';
                        highlightColorIndicator.style.border = '1px dashed #ccc';
                    } else {
                        document.execCommand('hiliteColor', false, color);
                        highlightColorIndicator.style.background = color;
                        highlightColorIndicator.style.border = 'none';
                    }
                    activeTextElement.focus();
                }
            }, true);
        });

        console.log('‚ú® Text formatting toolbar initialized with color pickers');

        // Advanced Font Picker function
        window.openAdvancedFontPicker = function() {
            if (typeof FontLoader !== 'undefined' && FontLoader.showFontPicker) {
                FontLoader.showFontPicker(activeTextElement, (fontFamily) => {
                    if (activeTextElement) {
                        activeTextElement.style.fontFamily = fontFamily;
                        activeTextElement.focus();
                        if (typeof saveToHistory === 'function') {
                            saveToHistory('change font');
                        }
                    }
                });
            } else {
                console.warn('FontLoader not available, falling back to alert');
                alert('Advanced font picker is loading. Please try again in a moment.');
            }
        };

        // Curved Text Panel function
        window.openCurvedTextPanel = function() {
            if (typeof CurvedText !== 'undefined' && CurvedText.renderControls) {
                // Create a modal for curved text controls
                let modal = document.getElementById('curvedTextModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'curvedTextModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 500px;">
                            <div class="modal-header">
                                <h3>Curved Text (11 Presets)</h3>
                                <button class="modal-close" onclick="document.getElementById('curvedTextModal').style.display='none'">&times;</button>
                            </div>
                            <div class="modal-body" id="curvedTextControls">
                                ${CurvedText.renderControls(activeTextElement)}
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                modal.style.display = 'flex';
            } else if (typeof CurvedText !== 'undefined' && CurvedText.addToCanvas) {
                // Fallback: just add curved text to canvas
                CurvedText.addToCanvas('Curved Text', 'arcUp');
            } else {
                console.warn('CurvedText not available');
                alert('Curved text feature is loading. Please try again in a moment.');
            }
        };

        // Text Animations Panel function
        window.openTextAnimationsPanel = function() {
            if (typeof TextAnimations !== 'undefined' && TextAnimations.renderPanel) {
                // Create a modal for text animations
                let modal = document.getElementById('textAnimationsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'textAnimationsModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h3>Text Animations (22 Effects)</h3>
                                <button class="modal-close" onclick="document.getElementById('textAnimationsModal').style.display='none'">&times;</button>
                            </div>
                            <div class="modal-body" id="textAnimationsControls"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                const controlsContainer = document.getElementById('textAnimationsControls');
                controlsContainer.innerHTML = '';
                TextAnimations.renderPanel(controlsContainer, activeTextElement);
                modal.style.display = 'flex';
            } else {
                console.warn('TextAnimations not available');
                alert('Text animations feature is loading. Please try again in a moment.');
            }
        };

        // Version History function
        window.openVersionHistory = function() {
            if (typeof VersionHistory !== 'undefined' && VersionHistory.showPanel) {
                VersionHistory.showPanel();
            } else {
                console.warn('VersionHistory not available');
                alert('Version history feature is loading. Please try again in a moment.');
            }
        };

        // Keyboard Shortcuts Help function
        window.openKeyboardShortcuts = function() {
            if (typeof KeyboardShortcuts !== 'undefined' && KeyboardShortcuts.showHelp) {
                KeyboardShortcuts.showHelp();
            } else {
                console.warn('KeyboardShortcuts not available');
                alert('Keyboard shortcuts help is loading. Press ? to view shortcuts.');
            }
        };

        // Stock Photos function
        window.openStockPhotos = function() {
            if (typeof StockPhotos !== 'undefined' && StockPhotos.showPanel) {
                StockPhotos.showPanel();
            } else if (typeof StockPhotos !== 'undefined' && StockPhotos.renderPanel) {
                // Create a modal for stock photos
                let modal = document.getElementById('stockPhotosModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'stockPhotosModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
                            <div class="modal-header">
                                <h3>Free Stock Photos</h3>
                                <button class="modal-close" onclick="document.getElementById('stockPhotosModal').style.display='none'">&times;</button>
                            </div>
                            <div class="modal-body" id="stockPhotosContent" style="overflow-y: auto; max-height: 60vh;"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    StockPhotos.renderPanel(document.getElementById('stockPhotosContent'));
                }
                modal.style.display = 'flex';
            } else {
                console.warn('StockPhotos not available');
                alert('Stock photos feature is loading. Please try again in a moment.');
            }
        };

        // Background Removal function
        window.openBackgroundRemoval = function() {
            if (typeof BackgroundRemoval !== 'undefined' && BackgroundRemoval.showModal) {
                BackgroundRemoval.showModal(window.selectedImageElement);
            } else {
                console.warn('BackgroundRemoval not available');
                alert('Background removal feature is loading. Please try again in a moment.');
            }
        };

        // Photo Effects function
        window.openPhotoEffects = function() {
            if (typeof PhotoEffects !== 'undefined' && PhotoEffects.show) {
                PhotoEffects.show(window.selectedImageElement);
            } else if (typeof PhotoEffects !== 'undefined') {
                // Create effects panel if show method doesn't exist
                let modal = document.getElementById('photoEffectsModal');
                if (!modal) {
                    const presets = PhotoEffects.getAllPresets ? PhotoEffects.getAllPresets() : [];
                    modal = document.createElement('div');
                    modal.id = 'photoEffectsModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 700px;">
                            <div class="modal-header">
                                <h3>Photo Effects & Filters (40+ Presets)</h3>
                                <button class="modal-close" onclick="document.getElementById('photoEffectsModal').style.display='none'">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="effects-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                                    ${presets.map(p => `
                                        <div class="effect-preset" onclick="PhotoEffects.applyPreset && PhotoEffects.applyPreset(window.selectedImageElement, '${p.id || p}')"
                                             style="padding: 10px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; text-align: center;">
                                            <div style="font-size: 12px;">${p.name || p}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                modal.style.display = 'flex';
            } else {
                console.warn('PhotoEffects not available');
                alert('Photo effects feature is loading. Please try again in a moment.');
            }
        };

        // Image Crop function
        window.openImageCrop = function() {
            if (typeof ImageEditor !== 'undefined' && ImageEditor.openCrop) {
                ImageEditor.openCrop(window.selectedImageElement);
            } else {
                console.warn('ImageEditor not available');
                alert('Image crop feature is loading. Please try again in a moment.');
            }
        };

        // Flip Image function
        window.flipSelectedImage = function() {
            if (window.selectedImageElement) {
                const currentTransform = window.selectedImageElement.style.transform || '';
                if (currentTransform.includes('scaleX(-1)')) {
                    window.selectedImageElement.style.transform = currentTransform.replace('scaleX(-1)', 'scaleX(1)');
                } else {
                    window.selectedImageElement.style.transform = currentTransform + ' scaleX(-1)';
                }
                if (typeof saveToHistory === 'function') {
                    saveToHistory('flip image');
                }
            }
        };

        // Track selected image element for image tools
        window.selectedImageElement = null;

        // Show image tools when clicking on images
        document.addEventListener('click', (e) => {
            const img = e.target.closest('img, .brochure-image, .gallery-image');
            const imageToolbar = document.getElementById('imageToolsToolbar');

            if (img && img.tagName === 'IMG') {
                window.selectedImageElement = img;
                if (imageToolbar) {
                    imageToolbar.style.display = 'flex';
                    const rect = img.getBoundingClientRect();
                    imageToolbar.style.left = `${rect.left}px`;
                    imageToolbar.style.top = `${rect.top - 50}px`;
                }
            } else if (!e.target.closest('#imageToolsToolbar')) {
                window.selectedImageElement = null;
                if (imageToolbar) {
                    imageToolbar.style.display = 'none';
                }
            }
        });

        // Line Height and Letter Spacing functions
        window.setTextLineHeight = function(value) {
            if (!activeTextElement) return;

            activeTextElement.style.lineHeight = value;

            // Update display
            const valueDisplay = document.getElementById('lineHeightValue');
            if (valueDisplay) valueDisplay.textContent = value;

            // Save to history
            if (typeof saveToHistory === 'function') {
                saveToHistory('change line height');
            }
        };

        window.setTextLetterSpacing = function(value) {
            if (!activeTextElement) return;

            activeTextElement.style.letterSpacing = value + 'px';

            // Update display
            const valueDisplay = document.getElementById('letterSpacingValue');
            if (valueDisplay) valueDisplay.textContent = value + 'px';

            // Save to history
            if (typeof saveToHistory === 'function') {
                saveToHistory('change letter spacing');
            }
        };

        // Update sliders when text element is selected
        const originalShowToolbar = window.showTextFormatToolbar || function() {};
        window.showTextFormatToolbar = function(element) {
            originalShowToolbar(element);

            // Read current line-height
            const computedStyle = window.getComputedStyle(element);
            let lineHeight = parseFloat(computedStyle.lineHeight);
            const fontSize = parseFloat(computedStyle.fontSize);
            if (!isNaN(lineHeight) && !isNaN(fontSize)) {
                lineHeight = lineHeight / fontSize;
            } else {
                lineHeight = 1.5;
            }

            const lineHeightSlider = document.getElementById('lineHeightSlider');
            const lineHeightValue = document.getElementById('lineHeightValue');
            if (lineHeightSlider) lineHeightSlider.value = lineHeight;
            if (lineHeightValue) lineHeightValue.textContent = lineHeight.toFixed(1);

            // Read current letter-spacing
            let letterSpacing = parseFloat(computedStyle.letterSpacing) || 0;
            const letterSpacingSlider = document.getElementById('letterSpacingSlider');
            const letterSpacingValue = document.getElementById('letterSpacingValue');
            if (letterSpacingSlider) letterSpacingSlider.value = letterSpacing;
            if (letterSpacingValue) letterSpacingValue.textContent = letterSpacing + 'px';
        };
    </script>

    <!-- Phase 2: Professional Tools -->
    <script src="element_drag.js?v=20251231_PHASE2"></script>
    <script src="elements_library_v2.js?v=20260115_CANVA"></script>
    <script src="elements_library.js?v=20260115_CANVA_V2"></script>
    <script src="qrcode_generator.js?v=20251231_PHASE2"></script>
    <script src="layer_system.js?v=20251231_PHASE2"></script>
    <script src="alignment_system.js?v=20251231_PHASE2"></script>
    <script src="text_effects.js?v=20251231_PHASE2B"></script>
    <script src="prebuilt_sections.js?v=20251231_PHASE2B"></script>
    <script src="visual_effects.js?v=20260115_CANVA"></script>
    <script src="template_picker.js?v=20260115_CANVA"></script>
    <script src="context_menu.js?v=20260115_CANVA"></script>
    <script src="zoom_controls.js?v=20260115_CANVA"></script>
    <script src="design_elements_extended.js?v=20260115_CANVA2"></script>
    <script src="curved_text.js?v=20260115_CANVA2"></script>
    <script src="enhanced_export.js?v=20260115_CANVA2"></script>
    <script src="export_modal.js?v=20260115_MODAL"></script>
    <script src="color_picker.js?v=20260115_COLOR"></script>
    <script src="backgrounds_library.js?v=20260115_BG"></script>
    <script src="photo_frames.js?v=20260115_FRAMES"></script>
    <script src="font_loader.js?v=20260115_FONTS"></script>
    <script src="brand_kit.js?v=20260115_CANVA2"></script>
    <script src="sharing.js?v=20260115_CANVA2"></script>
    <script src="template_mega_library.js?v=20260115_MEGA"></script>
    <script src="real_templates.js?v=20260115_REAL"></script>
    <script src="template_previews.js?v=20260115_PREVIEW"></script>
    <script src="stock_photos.js?v=20260115_STOCK"></script>
    <script src="stock_photos_api.js?v=20260115_API"></script>
    <script src="icons_expanded.js?v=20260115_ICONS"></script>
    <script src="element_grouping.js?v=20260115_GROUP"></script>
    <script src="property_charts.js?v=20260115_CHARTS"></script>
    <script src="text_animations.js?v=20260115_ANIM"></script>
    <script src="british_property_badges.js?v=20260115_UK"></script>
    <script src="british_property_features.js?v=20260115_UK2"></script>

    <!-- Phase 2: Advanced Features -->
    <script src="photo_effects.js?v=20260115_EFFECTS"></script>
    <script src="background_removal.js?v=20260115_BGREM"></script>
    <script src="onboarding.js?v=20260115_ONBOARD"></script>
    <script src="keyboard_shortcuts.js?v=20260115_KEYS"></script>

    <!-- Phase 3: Pro Features -->
    <script src="magic_resize.js?v=20260116_RESIZE"></script>
    <script src="animations.js?v=20260116_ANIM"></script>
    <script src="version_history.js?v=20260116_HISTORY"></script>

    <!-- Phase 4-5: Premium Features -->
    <script src="brand_kit_v2.js?v=20260116_BRAND"></script>
    <script src="ai_content.js?v=20260116_AI"></script>
    <script src="quick_actions.js?v=20260116_QUICK"></script>

    <!-- Canva-Rival Features -->
    <script src="property_graphics.js?v=20260116_GRAPHICS"></script>
    <script src="text_styles.js?v=20260116_TEXTSTYLES"></script>
    <script src="smart_guides.js?v=20260116_GUIDES"></script>

    <!-- Initialize Phase 2 features -->
    <script>
        // Tab switching for right panels
        document.querySelectorAll('.panel-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const panelId = tab.dataset.panel;

                // Update active tab
                document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Show corresponding panel
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                const panel = document.getElementById(panelId + 'Panel');
                if (panel) panel.classList.add('active');

                // Render panel content if needed
                if (panelId === 'elements') {
                    if (typeof ElementsLibrary !== 'undefined') {
                        ElementsLibrary.render();
                    }
                    if (typeof PrebuiltSections !== 'undefined') {
                        PrebuiltSections.render();
                    }
                } else if (panelId === 'templates' && typeof TemplatePicker !== 'undefined') {
                    TemplatePicker.render('templatePickerContent');
                } else if (panelId === 'effects' && typeof VisualEffects !== 'undefined') {
                    VisualEffects.renderPanel('visualEffectsContent');
                } else if (panelId === 'layers' && typeof LayerSystem !== 'undefined') {
                    LayerSystem.render();
                }
            });
        });

        // Initialize Phase 2 features when editor is ready
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                // Render alignment toolbar
                if (typeof AlignmentSystem !== 'undefined') {
                    AlignmentSystem.renderToolbar();
                }

                // Render elements panel
                if (typeof ElementsLibrary !== 'undefined') {
                    ElementsLibrary.render();
                }

                // Render prebuilt sections
                if (typeof PrebuiltSections !== 'undefined') {
                    PrebuiltSections.render();
                }

                // Render layer panel when page changes
                const originalSelectPage = window.selectPage;
                if (originalSelectPage) {
                    window.selectPage = function(pageId) {
                        originalSelectPage(pageId);
                        if (typeof LayerSystem !== 'undefined') {
                            LayerSystem.render();
                        }
                    };
                }
            }, 1000);
        });
    </script>
</body>
</html>
