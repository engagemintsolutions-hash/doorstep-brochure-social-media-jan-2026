<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brochure Editor - Professional Review Mode</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="brochure_editor_v3.css?v=20251231_CANVA_EDIT">
    <link rel="stylesheet" href="social_media_repurpose.css?v=20251028_SECTION1">
    <link rel="stylesheet" href="extended_features.css?v=20260115_CANVA2">
    <link rel="stylesheet" href="template_mega_library.css?v=20260115_MEGA">
</head>
<body>
    <!-- Header Bar -->
    <header class="editor-header">
        <div class="header-left">
            <button id="backBtn" class="icon-btn" title="Back to Builder">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>
            <h1 class="editor-title">Brochure Editor</h1>
            <span id="propertyAddress" class="property-label"></span>
        </div>
        <div class="header-center">
            <div class="status-indicator">
                <span id="statusDot" class="status-dot"></span>
                <span id="statusText" class="status-text">Loading session...</span>
            </div>
        </div>
        <div class="header-right">
            <!-- Undo/Redo Buttons with History Counter -->
            <div class="undo-redo-group">
                <button id="undoBtn" class="action-btn icon-only" title="Undo (Ctrl+Z)" disabled onclick="undo()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 7v6h6"/>
                        <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/>
                    </svg>
                </button>
                <span id="historyCounter" class="history-counter" title="History position" style="font-size: 11px; color: #666; min-width: 30px; text-align: center;">0/0</span>
                <button id="redoBtn" class="action-btn icon-only" title="Redo (Ctrl+Y)" disabled onclick="redo()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 7v6h-6"/>
                        <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"/>
                    </svg>
                </button>
                <button id="versionHistoryBtn" class="action-btn icon-only" title="Version History" onclick="openVersionHistory()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                </button>
                <button id="keyboardShortcutsBtn" class="action-btn icon-only" title="Keyboard Shortcuts (?)" onclick="openKeyboardShortcuts()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="4" width="20" height="16" rx="2"/>
                        <path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01"/>
                        <path d="M6 12h.01M10 12h.01M14 12h.01M18 12h.01"/>
                        <path d="M8 16h8"/>
                    </svg>
                </button>
            </div>

            <button id="toggleChatbotBtn" class="action-btn" title="Transform Text">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    <line x1="9" y1="10" x2="15" y2="10"></line>
                    <line x1="12" y1="7" x2="12" y2="13"></line>
                </svg>
                AI Transform
            </button>
            <button id="saveBtn" class="action-btn" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                </svg>
                Save
            </button>
            <button id="exportBtn" class="action-btn primary" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export PDF
            </button>
            <button id="moreExportsBtn" class="action-btn secondary" onclick="openExportOptions()" title="PNG, JPG, SVG, Social Media sizes">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                </svg>
                More Formats
            </button>
            <button id="repurposeBtn" class="action-btn secondary" onclick="openSocialMediaRepurpose()" style="background: linear-gradient(135deg, #0066FF 0%, #00CCFF 100%); border: none; color: white;" title="Repurpose to Social Media - Instagram, Facebook, LinkedIn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 1l4 4-4 4"/>
                    <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                    <path d="M7 23l-4-4 4-4"/>
                    <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                </svg>
                Repurpose
            </button>
            <button id="shareBtn" class="action-btn" onclick="openShareModal()" title="Share & Collaborate">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="18" cy="5" r="3"/>
                    <circle cx="6" cy="12" r="3"/>
                    <circle cx="18" cy="19" r="3"/>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                </svg>
                Share
            </button>
        </div>
    </header>

    <!-- Floating Image Tools Toolbar -->
    <div id="imageToolsToolbar" class="image-tools-toolbar" style="display: none;">
        <button class="format-btn" id="bgRemovalBtn" title="Remove Background" onclick="openBackgroundRemoval()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke-dasharray="4"/>
                <path d="M12 8v8M8 12h8"/>
            </svg>
            <span>Remove BG</span>
        </button>
        <button class="format-btn" id="photoEffectsBtn" title="Photo Effects & Filters (40+)" onclick="openPhotoEffects()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
            </svg>
            <span>Filters</span>
        </button>
        <button class="format-btn" id="cropImageBtn" title="Crop Image" onclick="openImageCrop()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6.13 1L6 16a2 2 0 0 0 2 2h15"/>
                <path d="M1 6.13L16 6a2 2 0 0 1 2 2v15"/>
            </svg>
            <span>Crop</span>
        </button>
        <button class="format-btn" id="flipImageBtn" title="Flip Image" onclick="flipSelectedImage()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3"/>
                <path d="M16 3h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-3"/>
                <line x1="12" y1="3" x2="12" y2="21"/>
            </svg>
            <span>Flip</span>
        </button>
    </div>

    <!-- Floating Element Style Panel -->
    <div id="elementStylePanel" class="element-style-panel" style="display: none;">
        <div class="style-panel-header">
            <span>Element Style</span>
            <button class="close-panel-btn" onclick="closeElementStylePanel()">&times;</button>
        </div>
        <div class="style-controls">
            <!-- Opacity Control -->
            <div class="style-control-group">
                <label>Opacity</label>
                <input type="range" id="elementOpacity" min="0" max="100" value="100" oninput="setElementOpacity(this.value)">
                <span id="opacityValue">100%</span>
            </div>
            <!-- Drop Shadow Control -->
            <div class="style-control-group">
                <label>Shadow</label>
                <div class="shadow-controls">
                    <input type="checkbox" id="shadowEnabled" onchange="toggleElementShadow(this.checked)">
                    <input type="range" id="shadowBlur" min="0" max="50" value="10" oninput="updateElementShadow()" disabled>
                    <input type="color" id="shadowColor" value="#000000" oninput="updateElementShadow()" disabled>
                </div>
            </div>
            <!-- Border Control -->
            <div class="style-control-group">
                <label>Border</label>
                <div class="border-controls">
                    <input type="number" id="borderWidth" min="0" max="20" value="0" oninput="updateElementBorder()" style="width: 50px;">
                    <select id="borderStyle" onchange="updateElementBorder()">
                        <option value="solid">Solid</option>
                        <option value="dashed">Dashed</option>
                        <option value="dotted">Dotted</option>
                    </select>
                    <input type="color" id="borderColor" value="#000000" oninput="updateElementBorder()">
                </div>
            </div>
            <!-- Border Radius -->
            <div class="style-control-group">
                <label>Corners</label>
                <input type="range" id="borderRadius" min="0" max="50" value="0" oninput="setElementCorners(this.value)">
                <span id="cornersValue">0px</span>
            </div>
        </div>
    </div>

    <!-- Floating Text Formatting Toolbar -->
    <div id="textFormatToolbar" class="text-format-toolbar" style="display: none;">
        <!-- Bold/Italic/Underline -->
        <button class="format-btn" data-command="bold" title="Bold (Ctrl+B)">
            <strong>B</strong>
        </button>
        <button class="format-btn" data-command="italic" title="Italic (Ctrl+I)">
            <em>I</em>
        </button>
        <button class="format-btn" data-command="underline" title="Underline (Ctrl+U)">
            <u>U</u>
        </button>
        <div class="toolbar-divider"></div>

        <!-- Text Style Presets -->
        <select class="format-select" id="textPresetSelect" title="Text Style Presets" style="max-width: 100px;" onchange="applyTextPreset(this.value)">
            <option value="">Styles</option>
            <option value="headline">Headline</option>
            <option value="subheadline">Subheadline</option>
            <option value="body">Body</option>
            <option value="caption">Caption</option>
            <option value="quote">Quote</option>
            <option value="price">Price Tag</option>
            <option value="cta">Call to Action</option>
            <option value="elegant">Elegant</option>
        </select>
        <div class="toolbar-divider"></div>

        <!-- Text Color Picker -->
        <div class="color-picker-wrapper" title="Text Color">
            <button class="format-btn color-btn" id="textColorBtn">
                <span style="font-weight: bold;">A</span>
                <div class="color-indicator" id="textColorIndicator" style="background: #000000;"></div>
            </button>
            <input type="color" id="textColorInput" value="#000000" style="display: none;">
        </div>

        <!-- Highlight Color Picker -->
        <div class="color-picker-wrapper" title="Highlight Color">
            <button class="format-btn color-btn" id="highlightColorBtn">
                <span style="background: yellow; padding: 0 4px;">A</span>
                <div class="color-indicator" id="highlightColorIndicator" style="background: transparent; border: 1px dashed #ccc;"></div>
            </button>
            <input type="color" id="highlightColorInput" value="#FFFF00" style="display: none;">
        </div>
        <div class="toolbar-divider"></div>

        <!-- Text Alignment -->
        <button class="format-btn" data-command="justifyLeft" title="Align Left">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v2H3V3zm0 4h12v2H3V7zm0 4h18v2H3v-2zm0 4h12v2H3v-2zm0 4h18v2H3v-2z"/></svg>
        </button>
        <button class="format-btn" data-command="justifyCenter" title="Align Center">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v2H3V3zm3 4h12v2H6V7zm-3 4h18v2H3v-2zm3 4h12v2H6v-2zm-3 4h18v2H3v-2z"/></svg>
        </button>
        <button class="format-btn" data-command="justifyRight" title="Align Right">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h18v2H3V3zm6 4h12v2H9V7zm-6 4h18v2H3v-2zm6 4h12v2H9v-2zm-6 4h18v2H3v-2z"/></svg>
        </button>
        <div class="toolbar-divider"></div>

        <!-- Font Size -->
        <select class="format-select" id="fontSizeSelect" title="Font Size">
            <option value="12px">12</option>
            <option value="14px">14</option>
            <option value="16px" selected>16</option>
            <option value="18px">18</option>
            <option value="20px">20</option>
            <option value="24px">24</option>
            <option value="28px">28</option>
            <option value="32px">32</option>
            <option value="36px">36</option>
            <option value="48px">48</option>
            <option value="64px">64</option>
        </select>

        <!-- Font Family -->
        <select class="format-select" id="fontFamilySelect" title="Font Family" style="max-width: 140px;">
            <optgroup label="Estate Agent Favorites">
                <option value="'Playfair Display', serif">Playfair Display</option>
                <option value="'Montserrat', sans-serif">Montserrat</option>
                <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
                <option value="'Raleway', sans-serif">Raleway</option>
                <option value="'Lora', serif">Lora</option>
            </optgroup>
            <optgroup label="Display & Serif">
                <option value="'Libre Baskerville', serif">Libre Baskerville</option>
                <option value="'Merriweather', serif">Merriweather</option>
                <option value="'Source Serif Pro', serif">Source Serif Pro</option>
                <option value="'EB Garamond', serif">EB Garamond</option>
                <option value="'PT Serif', serif">PT Serif</option>
            </optgroup>
            <optgroup label="Modern Sans-Serif">
                <option value="'Inter', sans-serif">Inter</option>
                <option value="'Poppins', sans-serif">Poppins</option>
                <option value="'Open Sans', sans-serif">Open Sans</option>
                <option value="'Roboto', sans-serif">Roboto</option>
                <option value="'Lato', sans-serif">Lato</option>
                <option value="'Nunito', sans-serif">Nunito</option>
                <option value="'Work Sans', sans-serif">Work Sans</option>
                <option value="'DM Sans', sans-serif">DM Sans</option>
            </optgroup>
            <optgroup label="Condensed">
                <option value="'Oswald', sans-serif">Oswald</option>
                <option value="'Roboto Condensed', sans-serif">Roboto Condensed</option>
                <option value="'Barlow Condensed', sans-serif">Barlow Condensed</option>
            </optgroup>
            <optgroup label="Handwriting">
                <option value="'Dancing Script', cursive">Dancing Script</option>
                <option value="'Pacifico', cursive">Pacifico</option>
                <option value="'Great Vibes', cursive">Great Vibes</option>
            </optgroup>
        </select>
        <!-- Advanced Font Picker Button -->
        <button class="format-btn" id="advancedFontsBtn" title="Browse 47+ Fonts" onclick="openAdvancedFontPicker()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 7V4h16v3"/>
                <path d="M9 20h6"/>
                <path d="M12 4v16"/>
            </svg>
        </button>
        <div class="toolbar-divider"></div>

        <!-- Line Height -->
        <div class="spacing-control" title="Line Height">
            <label>LH</label>
            <input type="range" id="lineHeightSlider" min="1" max="2.5" step="0.1" value="1.5"
                   oninput="setTextLineHeight(this.value)">
            <span id="lineHeightValue">1.5</span>
        </div>

        <!-- Letter Spacing -->
        <div class="spacing-control" title="Letter Spacing">
            <label>LS</label>
            <input type="range" id="letterSpacingSlider" min="-2" max="10" step="0.5" value="0"
                   oninput="setTextLetterSpacing(this.value)">
            <span id="letterSpacingValue">0px</span>
        </div>
        <div class="toolbar-divider"></div>

        <!-- Curved Text Button -->
        <button class="format-btn" id="curvedTextBtn" title="Curved Text (11 presets)" onclick="openCurvedTextPanel()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 12C2 6.5 6.5 2 12 2s10 4.5 10 10"/>
                <text x="7" y="18" font-size="8" fill="currentColor">Aa</text>
            </svg>
        </button>

        <!-- Text Animations Button -->
        <button class="format-btn" id="textAnimationsBtn" title="Text Animations (22 effects)" onclick="openTextAnimationsPanel()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
        </button>
        <div class="toolbar-divider"></div>

        <!-- Text Shadow Toggle -->
        <button class="format-btn" id="textShadowBtn" title="Text Shadow" onclick="toggleTextShadow()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <text x="4" y="16" font-size="14" font-weight="bold" fill="currentColor">S</text>
                <rect x="8" y="10" width="12" height="10" fill="#888" opacity="0.3" rx="1"/>
            </svg>
        </button>

        <!-- Text Outline Toggle -->
        <button class="format-btn" id="textOutlineBtn" title="Text Outline/Stroke" onclick="toggleTextOutline()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <text x="6" y="17" font-size="16" font-weight="bold" fill="none" stroke="currentColor" stroke-width="1">A</text>
            </svg>
        </button>
    </div>

    <!-- Main Content Area -->
    <main class="editor-main">
        <!-- Sidebar - Page List -->
        <aside class="pages-sidebar">
            <div class="sidebar-header">
                <h2>Pages</h2>
                <span id="pageCount" class="page-count">0 pages</span>
            </div>
            <div id="pageList" class="page-list">
                <!-- Pages will be dynamically inserted here -->
            </div>
            <div class="sidebar-actions">
                <button id="addPageBtn" class="add-page-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Page
                </button>
                <button id="duplicatePageBtn" class="duplicate-page-btn" onclick="duplicateCurrentPage()" title="Duplicate current page">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    Duplicate
                </button>
            </div>
        </aside>

        <!-- Photo Gallery Sidebar -->
        <aside class="photo-gallery-sidebar">
            <div class="sidebar-header">
                <h2>Photo Gallery</h2>
                <span id="photoCount" class="photo-count">0 photos</span>
            </div>
            <div class="upload-area" id="imageUploadArea">
                <input type="file" id="imageUploadInput" accept="image/*" multiple hidden>
                <div class="upload-prompt" onclick="document.getElementById('imageUploadInput').click()">
                    <span class="upload-icon">üì∑</span>
                    <span class="upload-text">Click to upload or drag images</span>
                </div>
            </div>
            <div class="stock-photos-btn-wrapper" style="padding: 8px;">
                <button id="stockPhotosBtn" class="action-btn secondary" onclick="openStockPhotos()" style="width: 100%; font-size: 13px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                    Free Stock Photos
                </button>
            </div>
            <div id="photoGalleryList" class="photo-gallery-list">
                <!-- Photos will be dynamically inserted here -->
            </div>
        </aside>

        <!-- Canvas Area - Brochure Preview -->
        <section class="canvas-area">
            <div class="canvas-toolbar">
                <div class="zoom-controls">
                    <button id="zoomOutBtn" class="tool-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            <line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                    <select id="zoomLevelSelect" class="zoom-select" title="Zoom Level" onchange="setZoomFromDropdown(this.value)">
                        <option value="0.25">25%</option>
                        <option value="0.50">50%</option>
                        <option value="0.65" selected>65%</option>
                        <option value="0.75">75%</option>
                        <option value="1.00">100%</option>
                        <option value="1.25">125%</option>
                        <option value="1.50">150%</option>
                        <option value="2.00">200%</option>
                    </select>
                    <button id="zoomInBtn" class="tool-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            <line x1="11" y1="8" x2="11" y2="14"/>
                            <line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                    <button id="fitToWidthBtn" class="tool-btn">Fit to Width</button>
                </div>
                <div class="view-mode">
                    <label>
                        <input type="checkbox" id="showGuidesToggle">
                        Guides
                    </label>
                    <label>
                        <input type="checkbox" id="showGridToggle" onchange="toggleCanvasGrid(this.checked)">
                        Grid
                    </label>
                    <label>
                        <input type="checkbox" id="showRulersToggle" onchange="toggleCanvasRulers(this.checked)">
                        Rulers
                    </label>
                </div>
                <div class="quick-tools">
                    <button id="eyedropperBtn" class="tool-btn" title="Eyedropper - Pick color from canvas" onclick="openEyedropper()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M2 22l1-1h3l9-9"/>
                            <path d="M3 21v-3l9-9"/>
                            <path d="M12 8l4-4 4 4-4 4"/>
                            <path d="M16 4l4 4"/>
                        </svg>
                    </button>
                    <button id="qrCodeQuickBtn" class="tool-btn" title="Add QR Code to page" onclick="addQRCodeQuick()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                            <rect x="17" y="17" width="4" height="4"/>
                            <line x1="14" y1="14" x2="14" y2="17"/>
                            <line x1="17" y1="14" x2="21" y2="14"/>
                        </svg>
                    </button>
                    <button id="styleElementBtn" class="tool-btn" title="Element Style - Opacity, Shadow, Border" onclick="openStylePanelForSelected()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                    </button>
                    <button id="lockElementBtn" class="tool-btn" title="Lock/Unlock Element (Ctrl+L)" onclick="toggleElementLock()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                    </button>
                    <button id="animateElementBtn" class="tool-btn" title="Animate Element - Add entrance/exit animations" onclick="openAnimations()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>
                    </button>
                    <button id="helpTourBtn" class="tool-btn" title="Help Tour - Guided walkthrough of editor features" onclick="startOnboardingTour()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                    </button>
                </div>
                <div class="template-selector">
                    <button id="openTemplatesBtn" class="tool-btn primary" title="Choose Design Template">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        Templates
                    </button>
                    <button id="openBrandKitBtn" class="tool-btn" title="Brand Kit - Colors, Fonts, Logos" onclick="openBrandKit()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="13.5" cy="6.5" r="2.5"/>
                            <circle cx="17.5" cy="10.5" r="2.5"/>
                            <circle cx="8.5" cy="7.5" r="2.5"/>
                            <circle cx="6.5" cy="12.5" r="2.5"/>
                            <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.563-2.512 5.563-5.563C22 6.5 17.5 2 12 2z"/>
                        </svg>
                        Brand Kit
                    </button>
                    <button id="openMagicResizeBtn" class="tool-btn" title="Magic Resize - Create Different Formats" onclick="openMagicResize()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 3 21 3 21 9"/>
                            <polyline points="9 21 3 21 3 15"/>
                            <line x1="21" y1="3" x2="14" y2="10"/>
                            <line x1="3" y1="21" x2="10" y2="14"/>
                        </svg>
                        Magic Resize
                    </button>
                </div>
                <div class="property-tools">
                    <button id="openPropertyBadgesBtn" class="tool-btn" title="Property Badges - SOLD, FOR SALE, EPC" onclick="openPropertyBadges()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
                            <line x1="7" y1="7" x2="7.01" y2="7"/>
                        </svg>
                        Badges
                    </button>
                    <button id="openPropertyChartsBtn" class="tool-btn" title="Property Charts - Area comparison, prices" onclick="openPropertyCharts()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10"/>
                            <line x1="12" y1="20" x2="12" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="14"/>
                            <line x1="2" y1="20" x2="22" y2="20"/>
                        </svg>
                        Charts
                    </button>
                    <button id="openAIContentBtn" class="tool-btn" title="AI Content - Generate property descriptions" onclick="openAIContent()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/>
                            <circle cx="8" cy="14" r="1"/>
                            <circle cx="16" cy="14" r="1"/>
                        </svg>
                        AI Text
                    </button>
                    <button id="openPropertyGraphicsBtn" class="tool-btn" title="Property Graphics - Icons, symbols, decorations" onclick="openPropertyGraphics()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                        </svg>
                        Graphics
                    </button>
                    <button id="openBackgroundsBtn" class="tool-btn" title="Page Backgrounds - Patterns, gradients, colors" onclick="openBackgrounds()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="2" width="20" height="20" rx="2"/>
                            <path d="M2 12h20"/>
                            <path d="M12 2v20"/>
                        </svg>
                        Backgrounds
                    </button>
                    <button id="openPhotoFramesBtn" class="tool-btn" title="Photo Frames - Shapes, decorative frames, grids" onclick="openPhotoFrames()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <rect x="6" y="6" width="12" height="12"/>
                        </svg>
                        Frames
                    </button>
                </div>
            </div>

            <div class="canvas-container" id="canvasContainer">
                <div class="canvas-scroll">
                    <div id="brochureCanvas" class="brochure-canvas">
                        <!-- Brochure pages will be rendered here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Right Panel Tabs Container -->
        <aside class="right-panels-container">
            <!-- Panel Tabs -->
            <div class="panel-tabs">
                <button class="panel-tab" data-panel="layouts">Layouts</button>
                <button class="panel-tab" data-panel="templates">Templates</button>
                <button class="panel-tab active" data-panel="elements">Elements</button>
                <button class="panel-tab" data-panel="effects">Effects</button>
                <button class="panel-tab" data-panel="layers">Layers</button>
            </div>

            <!-- Layout Picker Panel -->
            <div id="layoutsPanel" class="tab-panel">
                <div id="layoutPickerContent" class="layout-picker-content">
                    <!-- Layout previews will be dynamically inserted here -->
                </div>
            </div>

            <!-- Templates Panel -->
            <div id="templatesPanel" class="tab-panel">
                <div id="templatePickerContent">
                    <!-- Will be populated by template picker -->
                </div>
            </div>

            <!-- Elements Library Panel -->
            <div id="elementsPanel" class="tab-panel active">
                <!-- Elements Library Content (shapes, icons, QR) -->
                <div id="elementsLibraryContent">
                    <!-- Will be populated by elements_library.js -->
                </div>

                <!-- Pre-built Sections -->
                <div id="prebuiltSectionsContainer">
                    <!-- Will be populated by prebuilt_sections.js -->
                </div>

                <!-- Text Effects Panel (shows when text selected) -->
                <div id="textEffectsPanelContainer">
                    <!-- Will be populated by text_effects.js -->
                </div>
            </div>

            <!-- Visual Effects Panel -->
            <div id="effectsPanel" class="tab-panel">
                <div id="visualEffectsContent">
                    <!-- Will be populated by visual_effects.js -->
                </div>
            </div>

            <!-- Layers Panel -->
            <div id="layerPanel" class="tab-panel">
                <!-- Will be populated by layer_system.js -->
            </div>

            <!-- Alignment Toolbar (always visible) -->
            <div id="alignmentToolbar" class="alignment-toolbar">
                <!-- Will be populated by alignment_system.js -->
            </div>
        </aside>

        <!-- Text Transformation Chatbot Panel -->
        <aside id="chatbotPanel" class="chatbot-panel" style="display: none;">
            <div class="panel-header">
                <h2>Transform Text</h2>
                <button id="closeChatbotBtn" class="close-panel-btn" title="Close">&times;</button>
            </div>
            <div class="chatbot-content">
                <div class="chatbot-info">
                    <div class="current-page-info">
                        <span class="info-label">Current Page:</span>
                        <span id="chatbotPageTitle" class="info-value"></span>
                    </div>
                    <div class="word-count-info">
                        <span class="info-label">Word Count:</span>
                        <span id="chatbotWordCount" class="info-value">0 words</span>
                    </div>
                </div>

                <div class="transformation-styles">
                    <h3>Quick Transforms</h3>
                    <div class="style-buttons">
                        <button class="style-btn" data-style="bullet_points">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                            </svg>
                            <span>Bullet Points</span>
                        </button>
                        <button class="style-btn" data-style="key_features">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>
                            <span>Key Features</span>
                        </button>
                        <button class="style-btn" data-style="concise">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                            </svg>
                            <span>Make Concise</span>
                        </button>
                        <button class="style-btn" data-style="elaborate">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 20h9"></path>
                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                            </svg>
                            <span>Elaborate</span>
                        </button>
                        <button class="style-btn" data-style="professional">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                            </svg>
                            <span>Professional</span>
                        </button>
                        <button class="style-btn" data-style="friendly">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                <line x1="15" y1="9" x2="15.01" y2="9"></line>
                            </svg>
                            <span>Friendly</span>
                        </button>
                    </div>
                </div>

                <div class="custom-transformation">
                    <h3>Custom Instruction</h3>
                    <textarea id="customInstruction" placeholder="Enter custom instructions for transformation..." rows="3"></textarea>
                    <button id="customTransformBtn" class="action-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Transform with Custom Instruction
                    </button>
                </div>
            </div>
        </aside>

        <!-- Design Templates Panel (Overlay) -->
        <aside id="templatesPanelOverlay" class="templates-panel">
            <div class="panel-header">
                <h2>üé® Design Templates</h2>
                <button id="closeTemplatesBtn" class="close-panel-btn" title="Close">&times;</button>
            </div>
            <div class="templates-content">
                <div class="templates-info">
                    <p>Choose a design template to instantly transform your brochure's appearance with professional color schemes, borders, and accents.</p>
                </div>

                <!-- Free Templates -->
                <div class="template-section">
                    <h3>‚ú® Free Templates</h3>
                    <div class="template-grid" id="freeTemplatesGrid">
                        <!-- Generated dynamically -->
                    </div>
                </div>

                <!-- Premium Templates -->
                <div class="template-section">
                    <h3>üëë Premium Templates</h3>
                    <p class="premium-note">Unlock premium templates for more sophisticated designs</p>
                    <div class="template-grid premium-grid" id="premiumTemplatesGrid">
                        <!-- Generated dynamically -->
                    </div>
                </div>

                <!-- Reset Option -->
                <button id="resetTemplateBtn" class="action-btn secondary" style="margin-top: 20px; width: 100%;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="1 4 1 10 7 10"></polyline>
                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                    </svg>
                    Reset to Default
                </button>
            </div>
        </aside>
    </main>

    <!-- Text Transformation Preview Modal -->
    <div id="transformPreviewModal" class="modal" style="display: none;">
        <div class="modal-content transform-preview">
            <div class="modal-header">
                <h3>Preview Text Transformation</h3>
                <button class="modal-close" id="closePreviewBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="preview-info">
                    <span class="preview-message" id="previewMessage"></span>
                </div>
                <div class="comparison-view">
                    <div class="text-column">
                        <h4>Current Text</h4>
                        <div class="text-preview original" id="originalTextPreview"></div>
                        <div class="text-stats">
                            <span id="originalWordCount">0 words</span>
                            <span id="originalCharCount">0 characters</span>
                        </div>
                    </div>
                    <div class="arrow-divider">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                            <polyline points="12 5 19 12 12 19"></polyline>
                        </svg>
                    </div>
                    <div class="text-column">
                        <h4>Transformed Text</h4>
                        <div class="text-preview transformed" id="transformedTextPreview"></div>
                        <div class="text-stats">
                            <span id="transformedWordCount">0 words</span>
                            <span id="transformedCharCount">0 characters</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelTransformBtn" class="btn secondary">Cancel</button>
                <button id="applyTransformBtn" class="btn primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Apply Transformation
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay with Progress -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-modal">
            <div class="loading-header">
                <div class="spinner"></div>
                <h2>Preparing Your Brochure</h2>
                <p class="loading-subtitle">Our AI is crafting bespoke descriptions for each space</p>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <span id="progressText" class="progress-text">0%</span>
            </div>

            <button id="skipGenerationBtn" class="skip-generation-btn" onclick="skipAIGeneration()">
                Skip & Load Now (Use Default Text)
            </button>

            <div id="loadingSteps" class="loading-steps">
                <div class="step" data-step="session">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Loading session data...</span>
                </div>
                <div class="step" data-step="kitchen">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Generating kitchen description...</span>
                </div>
                <div class="step" data-step="living">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Generating living spaces description...</span>
                </div>
                <div class="step" data-step="bedrooms">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Generating bedrooms description...</span>
                </div>
                <div class="step" data-step="bathrooms">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Generating bathrooms description...</span>
                </div>
                <div class="step" data-step="garden">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Generating outdoor spaces description...</span>
                </div>
                <div class="step" data-step="location">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Generating location description...</span>
                </div>
                <div class="step" data-step="rendering">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Rendering brochure pages...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content error">
            <div class="modal-header">
                <h3>Error</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="errorMessage"></p>
            </div>
            <div class="modal-footer">
                <button id="errorRetryBtn" class="btn">Retry</button>
                <button id="errorBackBtn" class="btn secondary">Back to Builder</button>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="toast success">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span id="toastMessage"></span>
    </div>

    <script src="unified_brochure_builder.js?v=20251231_AUTOGEN"></script>
    <script src="brochure_editor_v3.js?v=20251231_CANVA_PREMIUM2"></script>
    <script src="brochure_editor_chatbot.js?v=20251020_FINAL"></script>
    <script src="image_editor.js?v=20251231_CANVA_EDIT"></script>
    <script src="photo_gallery_manager.js?v=20251020_CLEAN_TEMPLATES"></script>
    <script src="post_export_system.js?v=20251020_ADVANCED_AI"></script>
    <script src="brochure_templates.js?v=20251020_TEMPLATE_DEBUG"></script>
    <script src="social_media_repurpose.js?v=20251028_SECTION1"></script>
    <script>
        // Initialize templates panel (overlay)
        document.addEventListener('DOMContentLoaded', () => {
            const templatesPanel = document.getElementById('templatesPanelOverlay');
            const openTemplatesBtn = document.getElementById('openTemplatesBtn');
            const closeTemplatesBtn = document.getElementById('closeTemplatesBtn');
            const resetTemplateBtn = document.getElementById('resetTemplateBtn');

            if (!openTemplatesBtn || !templatesPanel) {
                console.error('Templates panel elements not found!');
                return;
            }

            // Open/close panel
            openTemplatesBtn.addEventListener('click', () => {
                console.log('üé® Templates button clicked!');
                console.log('BrochureTemplates available?', !!window.BrochureTemplates);
                console.log('getAvailableTemplates available?', !!window.getAvailableTemplates);

                if (!window.BrochureTemplates) {
                    console.error('‚ùå BrochureTemplates not loaded!');
                    alert('Error: Templates not loaded. Please refresh the page.');
                    return;
                }

                console.log('Free templates:', window.BrochureTemplates.free);
                console.log('Free templates count:', Object.keys(window.BrochureTemplates.free).length);

                templatesPanel.classList.add('active');
                templatesPanel.style.display = 'flex';
                initializeTemplates();
            });

            closeTemplatesBtn.addEventListener('click', () => {
                templatesPanel.classList.remove('active');
            });

            // Reset template
            resetTemplateBtn.addEventListener('click', () => {
                window.applyTemplateToAll('savills_classic');
                alert('Reset to Savills Classic template');
            });

            // Initialize templates when panel opens
            function initializeTemplates() {
                const hasPremium = false; // TODO: Check user's subscription
                populateTemplates(hasPremium);
            }

            // Populate template grids
            function populateTemplates(hasPremium) {
                try {
                    const freeGrid = document.getElementById('freeTemplatesGrid');
                    const premiumGrid = document.getElementById('premiumTemplatesGrid');

                    console.log('üìã Populating templates...');
                    console.log('Free grid element:', freeGrid);
                    console.log('Premium grid element:', premiumGrid);

                    if (!freeGrid || !premiumGrid) {
                        console.error('‚ùå Grid elements not found!');
                        return;
                    }

                    // Clear existing
                    freeGrid.innerHTML = '';
                    premiumGrid.innerHTML = '';

                    // Get templates
                    if (!window.getAvailableTemplates) {
                        console.error('‚ùå getAvailableTemplates function not available!');
                        return;
                    }

                    const templates = window.getAvailableTemplates(hasPremium);
                    console.log('Available templates:', templates);
                    console.log('Number of templates:', templates.length);

                    // Separate free and premium
                    const freeTemplates = templates.filter(t => t.tier === 'free');
                    const premiumTemplates = Object.values(window.BrochureTemplates.premium || {});

                    console.log('Free templates to render:', freeTemplates.length);
                    console.log('Premium templates to render:', premiumTemplates.length);

                    // Render free templates
                    freeTemplates.forEach((template, index) => {
                        console.log(`Creating card ${index + 1}:`, template.name);
                        const card = createTemplateCard(template, true);
                        freeGrid.appendChild(card);
                        console.log(`‚úÖ Card ${index + 1} appended to grid`);
                    });

                    console.log('Final freeGrid children count:', freeGrid.children.length);

                    // Render premium templates (if any)
                    if (premiumTemplates.length > 0) {
                        premiumTemplates.forEach(template => {
                            const card = createTemplateCard(template, hasPremium);
                            premiumGrid.appendChild(card);
                        });
                    } else {
                        // Hide premium section if empty
                        const premiumSection = premiumGrid.closest('.template-section');
                        if (premiumSection) {
                            premiumSection.style.display = 'none';
                            console.log('‚úÖ Premium section hidden (no premium templates)');
                        }
                    }

                    console.log('‚úÖ Templates populated successfully!');
                } catch (error) {
                    console.error('‚ùå Error populating templates:', error);
                }
            }

            // Create template card element
            function createTemplateCard(template, isUnlocked) {
                const card = document.createElement('div');
                card.className = 'template-card' + (isUnlocked ? ' unlocked' : '');
                card.dataset.templateId = template.id;

                // Check if this template is active
                const currentTemplate = (window.EditorState && window.EditorState.activeTemplate) || 'savills_classic';
                if (template.id === currentTemplate) {
                    card.classList.add('active');
                }

                card.innerHTML = `
                    <div class="template-card-header">
                        <div class="template-preview">${template.preview}</div>
                        <div class="template-info">
                            <div class="template-name">${template.name}</div>
                            <span class="template-tier ${template.tier}">${template.tier}</span>
                        </div>
                    </div>
                    <div class="template-description">${template.description}</div>
                `;

                // Click handler
                if (isUnlocked) {
                    card.addEventListener('click', () => {
                        // Remove active class from all cards
                        document.querySelectorAll('.template-card').forEach(c => c.classList.remove('active'));
                        card.classList.add('active');

                        // Apply template
                        window.applyTemplateToAll(template.id);

                        // Show success message
                        console.log(`‚úÖ Applied template: ${template.name}`);
                    });
                } else {
                    card.addEventListener('click', () => {
                        alert('üîí This is a premium template. Upgrade to unlock premium designs!');
                    });
                }

                return card;
            }
        });

        // ====================================================================
        // TEXT FORMATTING TOOLBAR
        // ====================================================================
        const formatToolbar = document.getElementById('textFormatToolbar');
        let activeTextElement = null;

        // Show toolbar when clicking on editable text
        document.addEventListener('click', (e) => {
            const editable = e.target.closest('[contenteditable="true"]');

            if (editable) {
                activeTextElement = editable;
                showToolbar(e.clientX, e.clientY);
                updateToolbarState(editable);
            } else if (!formatToolbar.contains(e.target)) {
                hideToolbar();
            }
        });

        function showToolbar(x, y) {
            formatToolbar.style.display = 'flex';
            formatToolbar.style.left = `${x}px`;
            formatToolbar.style.top = `${y - 50}px`; // Position above click
        }

        function hideToolbar() {
            formatToolbar.style.display = 'none';
            activeTextElement = null;
        }

        function updateToolbarState(element) {
            // Update button active states
            document.querySelectorAll('.format-btn').forEach(btn => {
                const command = btn.dataset.command;
                const isActive = document.queryCommandState(command);
                btn.classList.toggle('active', isActive);
            });

            // Update font size dropdown
            const fontSize = window.getComputedStyle(element).fontSize;
            document.getElementById('fontSizeSelect').value = fontSize;

            // Update font family dropdown
            const fontFamily = window.getComputedStyle(element).fontFamily;
            document.getElementById('fontFamilySelect').value = fontFamily;
        }

        // Handle format button clicks
        document.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const command = btn.dataset.command;
                document.execCommand(command, false, null);
                btn.classList.toggle('active');
                if (activeTextElement) {
                    activeTextElement.focus();
                }
            });
        });

        // Handle font size change
        document.getElementById('fontSizeSelect').addEventListener('change', (e) => {
            if (activeTextElement) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.style.fontSize = e.target.value;
                    range.surroundContents(span);
                } else {
                    activeTextElement.style.fontSize = e.target.value;
                }
                activeTextElement.focus();
            }
        });

        // Handle font family change
        document.getElementById('fontFamilySelect').addEventListener('change', (e) => {
            if (activeTextElement) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.style.fontFamily = e.target.value;
                    range.surroundContents(span);
                } else {
                    activeTextElement.style.fontFamily = e.target.value;
                }
                activeTextElement.focus();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (!activeTextElement) return;

            if (e.ctrlKey || e.metaKey) {
                switch(e.key.toLowerCase()) {
                    case 'b':
                        e.preventDefault();
                        document.execCommand('bold');
                        break;
                    case 'i':
                        e.preventDefault();
                        document.execCommand('italic');
                        break;
                    case 'u':
                        e.preventDefault();
                        document.execCommand('underline');
                        break;
                }
            }
        });

        // ====================================================================
        // RECENT COLORS SYSTEM
        // ====================================================================
        window.RecentColors = (function() {
            const MAX_RECENT = 12;
            const STORAGE_KEY = 'brochureEditor_recentColors';

            let recentColors = [];

            // Load from localStorage
            function load() {
                try {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (stored) {
                        recentColors = JSON.parse(stored);
                    }
                } catch (e) {
                    recentColors = [];
                }
                return recentColors;
            }

            // Save to localStorage
            function save() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(recentColors));
                } catch (e) {
                    console.warn('Could not save recent colors');
                }
            }

            // Add a color to recent
            function add(color) {
                if (!color || color === 'transparent') return;

                // Normalize color to uppercase hex
                color = color.toUpperCase();
                if (!color.startsWith('#')) {
                    color = '#' + color;
                }

                // Remove if already exists
                const index = recentColors.indexOf(color);
                if (index > -1) {
                    recentColors.splice(index, 1);
                }

                // Add to front
                recentColors.unshift(color);

                // Limit to max
                if (recentColors.length > MAX_RECENT) {
                    recentColors = recentColors.slice(0, MAX_RECENT);
                }

                save();
            }

            // Get recent colors
            function get() {
                return [...recentColors];
            }

            // Initialize
            load();

            return { add, get, load };
        })();

        // ====================================================================
        // TEXT COLOR PICKER
        // ====================================================================
        const textColorBtn = document.getElementById('textColorBtn');
        const textColorInput = document.getElementById('textColorInput');
        const textColorIndicator = document.getElementById('textColorIndicator');
        const highlightColorBtn = document.getElementById('highlightColorBtn');
        const highlightColorInput = document.getElementById('highlightColorInput');
        const highlightColorIndicator = document.getElementById('highlightColorIndicator');

        // Color presets
        const colorPresets = [
            '#000000', '#374151', '#6B7280', '#9CA3AF', '#D1D5DB', '#FFFFFF',
            '#C20430', '#DC2626', '#EA580C', '#F59E0B', '#84CC16', '#22C55E',
            '#14B8A6', '#0EA5E9', '#3B82F6', '#6366F1', '#8B5CF6', '#A855F7',
            '#D946EF', '#EC4899', '#F43F5E', '#78350F', '#1E3A8A', '#064E3B'
        ];

        // Update recent colors display in existing dropdown
        function updateRecentColorsDisplay(dropdown) {
            if (!window.RecentColors) return;

            const recentColors = window.RecentColors.get();
            let recentSection = dropdown.querySelector('.recent-colors-grid');
            let recentLabel = dropdown.querySelector('.color-section-label');

            if (recentColors.length > 0) {
                if (!recentSection) {
                    // Create recent section if it doesn't exist
                    const allColorsLabel = document.createElement('div');
                    allColorsLabel.className = 'color-section-label';
                    allColorsLabel.textContent = 'All Colors';

                    recentLabel = document.createElement('div');
                    recentLabel.className = 'color-section-label';
                    recentLabel.textContent = 'Recent';

                    recentSection = document.createElement('div');
                    recentSection.className = 'recent-colors-grid';

                    const swatchesGrid = dropdown.querySelector('.color-swatches-grid');
                    swatchesGrid.parentNode.insertBefore(recentLabel, swatchesGrid);
                    swatchesGrid.parentNode.insertBefore(recentSection, swatchesGrid);
                    swatchesGrid.parentNode.insertBefore(allColorsLabel, swatchesGrid);
                }

                // Update the recent colors
                recentSection.innerHTML = recentColors.map(color => `
                    <div class="color-swatch recent-color" data-color="${color}" style="background: ${color};"></div>
                `).join('');

                // Re-attach click handlers
                recentSection.querySelectorAll('.color-swatch').forEach(swatch => {
                    swatch.addEventListener('click', () => {
                        const color = swatch.dataset.color;
                        // Trigger the same color select callback
                        dropdown.dispatchEvent(new CustomEvent('colorSelect', { detail: color }));
                        dropdown.classList.remove('visible');
                    });
                });
            }
        }

        // Create color swatches dropdown
        function createColorSwatches(targetBtn, onColorSelect, showClear = false) {
            const existing = targetBtn.parentElement.querySelector('.color-swatches');
            if (existing) {
                existing.classList.toggle('visible');
                // Refresh recent colors if visible
                if (existing.classList.contains('visible')) {
                    updateRecentColorsDisplay(existing);
                }
                return;
            }

            const recentColors = window.RecentColors ? window.RecentColors.get() : [];

            const dropdown = document.createElement('div');
            dropdown.className = 'color-swatches visible';
            dropdown.innerHTML = `
                ${recentColors.length > 0 ? `
                    <div class="color-section-label">Recent</div>
                    <div class="recent-colors-grid">
                        ${recentColors.map(color => `
                            <div class="color-swatch recent-color" data-color="${color}" style="background: ${color};"></div>
                        `).join('')}
                    </div>
                    <div class="color-section-label">All Colors</div>
                ` : ''}
                <div class="color-swatches-grid">
                    ${colorPresets.map(color => `
                        <div class="color-swatch" data-color="${color}" style="background: ${color};"></div>
                    `).join('')}
                </div>
                <div class="color-custom-input">
                    <label>Custom:</label>
                    <input type="color" value="#000000">
                    <input type="text" placeholder="#000000" maxlength="7">
                </div>
                ${showClear ? '<button class="color-clear-btn">Remove Highlight</button>' : ''}
            `;

            // Add styles for recent colors section
            if (!document.getElementById('recent-colors-styles')) {
                const styles = document.createElement('style');
                styles.id = 'recent-colors-styles';
                styles.textContent = `
                    .color-section-label {
                        font-size: 10px;
                        color: #888;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        margin: 8px 0 4px;
                        padding: 0 4px;
                    }
                    .recent-colors-grid {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 4px;
                        margin-bottom: 8px;
                    }
                    .recent-colors-grid .color-swatch {
                        width: 20px;
                        height: 20px;
                        border-radius: 3px;
                    }
                `;
                document.head.appendChild(styles);
            }

            targetBtn.parentElement.appendChild(dropdown);

            // Handle swatch clicks
            dropdown.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', () => {
                    const color = swatch.dataset.color;
                    // Add to recent colors
                    if (window.RecentColors) {
                        window.RecentColors.add(color);
                    }
                    onColorSelect(color);
                    dropdown.classList.remove('visible');
                });
            });

            // Handle custom color input
            const customColorInput = dropdown.querySelector('input[type="color"]');
            const customTextInput = dropdown.querySelector('input[type="text"]');

            customColorInput.addEventListener('input', (e) => {
                customTextInput.value = e.target.value;
                // Add to recent colors
                if (window.RecentColors) {
                    window.RecentColors.add(e.target.value);
                }
                onColorSelect(e.target.value);
            });

            customTextInput.addEventListener('change', (e) => {
                let val = e.target.value;
                if (!val.startsWith('#')) val = '#' + val;
                if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
                    customColorInput.value = val;
                    // Add to recent colors
                    if (window.RecentColors) {
                        window.RecentColors.add(val);
                    }
                    onColorSelect(val);
                }
            });

            // Handle clear button
            if (showClear) {
                dropdown.querySelector('.color-clear-btn').addEventListener('click', () => {
                    onColorSelect('transparent');
                    dropdown.classList.remove('visible');
                });
            }

            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!dropdown.contains(e.target) && !targetBtn.contains(e.target)) {
                        dropdown.classList.remove('visible');
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 10);
        }

        // Text color button click
        textColorBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            createColorSwatches(textColorBtn, (color) => {
                if (activeTextElement) {
                    document.execCommand('foreColor', false, color);
                    textColorIndicator.style.background = color;
                    activeTextElement.focus();
                }
            });
        });

        // Highlight color button click
        highlightColorBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            createColorSwatches(highlightColorBtn, (color) => {
                if (activeTextElement) {
                    if (color === 'transparent') {
                        document.execCommand('removeFormat', false, null);
                        highlightColorIndicator.style.background = 'transparent';
                        highlightColorIndicator.style.border = '1px dashed #ccc';
                    } else {
                        document.execCommand('hiliteColor', false, color);
                        highlightColorIndicator.style.background = color;
                        highlightColorIndicator.style.border = 'none';
                    }
                    activeTextElement.focus();
                }
            }, true);
        });

        console.log('‚ú® Text formatting toolbar initialized with color pickers');

        // Text Shadow Toggle function
        window.toggleTextShadow = function() {
            if (activeTextElement) {
                const currentShadow = activeTextElement.style.textShadow;
                if (currentShadow && currentShadow !== 'none') {
                    activeTextElement.style.textShadow = 'none';
                    document.getElementById('textShadowBtn').classList.remove('active');
                    showToast('Text shadow removed', 'info');
                } else {
                    activeTextElement.style.textShadow = '2px 2px 4px rgba(0,0,0,0.3)';
                    document.getElementById('textShadowBtn').classList.add('active');
                    showToast('Text shadow applied', 'success');
                }
                if (typeof saveToHistory === 'function') {
                    saveToHistory('toggle text shadow');
                }
            } else {
                alert('Please select a text element first.');
            }
        };

        // Text Outline Toggle function
        window.toggleTextOutline = function() {
            if (activeTextElement) {
                const currentOutline = activeTextElement.style.webkitTextStroke || activeTextElement.style.textStroke;
                if (currentOutline && currentOutline !== '0px') {
                    activeTextElement.style.webkitTextStroke = '0px';
                    activeTextElement.style.textStroke = '0px';
                    document.getElementById('textOutlineBtn').classList.remove('active');
                    showToast('Text outline removed', 'info');
                } else {
                    activeTextElement.style.webkitTextStroke = '1px #000';
                    activeTextElement.style.textStroke = '1px #000';
                    document.getElementById('textOutlineBtn').classList.add('active');
                    showToast('Text outline applied', 'success');
                }
                if (typeof saveToHistory === 'function') {
                    saveToHistory('toggle text outline');
                }
            } else {
                alert('Please select a text element first.');
            }
        };

        // Text Style Presets
        window.applyTextPreset = function(preset) {
            if (!activeTextElement) {
                alert('Please select a text element first.');
                document.getElementById('textPresetSelect').value = '';
                return;
            }

            const presets = {
                headline: {
                    fontSize: '36px',
                    fontWeight: 'bold',
                    fontFamily: "'Playfair Display', serif",
                    lineHeight: '1.2',
                    letterSpacing: '0px',
                    color: '#1a1a1a'
                },
                subheadline: {
                    fontSize: '24px',
                    fontWeight: '600',
                    fontFamily: "'Montserrat', sans-serif",
                    lineHeight: '1.3',
                    letterSpacing: '0.5px',
                    color: '#333333'
                },
                body: {
                    fontSize: '16px',
                    fontWeight: 'normal',
                    fontFamily: "'Open Sans', sans-serif",
                    lineHeight: '1.6',
                    letterSpacing: '0px',
                    color: '#4a4a4a'
                },
                caption: {
                    fontSize: '12px',
                    fontWeight: 'normal',
                    fontFamily: "'Inter', sans-serif",
                    lineHeight: '1.4',
                    letterSpacing: '0.2px',
                    color: '#666666'
                },
                quote: {
                    fontSize: '20px',
                    fontWeight: 'normal',
                    fontStyle: 'italic',
                    fontFamily: "'Lora', serif",
                    lineHeight: '1.5',
                    letterSpacing: '0px',
                    color: '#555555'
                },
                price: {
                    fontSize: '32px',
                    fontWeight: 'bold',
                    fontFamily: "'Oswald', sans-serif",
                    lineHeight: '1.1',
                    letterSpacing: '1px',
                    color: '#FF9800'
                },
                cta: {
                    fontSize: '18px',
                    fontWeight: 'bold',
                    fontFamily: "'Poppins', sans-serif",
                    lineHeight: '1.2',
                    letterSpacing: '1px',
                    textTransform: 'uppercase',
                    color: '#2196F3'
                },
                elegant: {
                    fontSize: '28px',
                    fontWeight: '300',
                    fontFamily: "'Cormorant Garamond', serif",
                    lineHeight: '1.4',
                    letterSpacing: '2px',
                    color: '#2c3e50'
                }
            };

            const style = presets[preset];
            if (!style) {
                document.getElementById('textPresetSelect').value = '';
                return;
            }

            // Apply all styles
            Object.keys(style).forEach(prop => {
                activeTextElement.style[prop] = style[prop];
            });

            // Update toolbar controls to reflect changes
            const fontSizeSelect = document.getElementById('fontSizeSelect');
            const fontFamilySelect = document.getElementById('fontFamilySelect');
            if (fontSizeSelect) {
                fontSizeSelect.value = style.fontSize;
            }
            if (fontFamilySelect) {
                fontFamilySelect.value = style.fontFamily;
            }

            // Reset dropdown after applying
            setTimeout(() => {
                document.getElementById('textPresetSelect').value = '';
            }, 100);

            showToast(`"${preset}" style applied`, 'success');

            if (typeof saveToHistory === 'function') {
                saveToHistory(`apply ${preset} preset`);
            }
        };

        // Advanced Font Picker function
        window.openAdvancedFontPicker = function() {
            if (typeof FontLoader !== 'undefined' && FontLoader.showFontPicker) {
                FontLoader.showFontPicker(activeTextElement, (fontFamily) => {
                    if (activeTextElement) {
                        activeTextElement.style.fontFamily = fontFamily;
                        activeTextElement.focus();
                        if (typeof saveToHistory === 'function') {
                            saveToHistory('change font');
                        }
                    }
                });
            } else {
                console.warn('FontLoader not available, falling back to alert');
                alert('Advanced font picker is loading. Please try again in a moment.');
            }
        };

        // Curved Text Panel function
        window.openCurvedTextPanel = function() {
            if (typeof CurvedText !== 'undefined' && CurvedText.renderControls) {
                // Create a modal for curved text controls
                let modal = document.getElementById('curvedTextModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'curvedTextModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 500px;">
                            <div class="modal-header">
                                <h3>Curved Text (11 Presets)</h3>
                                <button class="modal-close" onclick="document.getElementById('curvedTextModal').style.display='none'">&times;</button>
                            </div>
                            <div class="modal-body" id="curvedTextControls">
                                ${CurvedText.renderControls(activeTextElement)}
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                modal.style.display = 'flex';
            } else if (typeof CurvedText !== 'undefined' && CurvedText.addToCanvas) {
                // Fallback: just add curved text to canvas
                CurvedText.addToCanvas('Curved Text', 'arcUp');
            } else {
                console.warn('CurvedText not available');
                alert('Curved text feature is loading. Please try again in a moment.');
            }
        };

        // Text Animations Panel function
        window.openTextAnimationsPanel = function() {
            if (typeof TextAnimations !== 'undefined' && TextAnimations.renderPanel) {
                // Create a modal for text animations
                let modal = document.getElementById('textAnimationsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'textAnimationsModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h3>Text Animations (22 Effects)</h3>
                                <button class="modal-close" onclick="document.getElementById('textAnimationsModal').style.display='none'">&times;</button>
                            </div>
                            <div class="modal-body" id="textAnimationsControls"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                const controlsContainer = document.getElementById('textAnimationsControls');
                controlsContainer.innerHTML = '';
                TextAnimations.renderPanel(controlsContainer, activeTextElement);
                modal.style.display = 'flex';
            } else {
                console.warn('TextAnimations not available');
                alert('Text animations feature is loading. Please try again in a moment.');
            }
        };

        // Version History function
        window.openVersionHistory = function() {
            if (typeof VersionHistory !== 'undefined' && VersionHistory.showPanel) {
                VersionHistory.showPanel();
            } else {
                console.warn('VersionHistory not available');
                alert('Version history feature is loading. Please try again in a moment.');
            }
        };

        // Keyboard Shortcuts Help function
        window.openKeyboardShortcuts = function() {
            if (typeof KeyboardShortcuts !== 'undefined' && KeyboardShortcuts.showHelp) {
                KeyboardShortcuts.showHelp();
            } else {
                console.warn('KeyboardShortcuts not available');
                alert('Keyboard shortcuts help is loading. Press ? to view shortcuts.');
            }
        };

        // Eyedropper function
        window.openEyedropper = function() {
            if (typeof ColorPicker !== 'undefined' && ColorPicker.startEyedropper) {
                ColorPicker.startEyedropper().then(result => {
                    if (result && result.sRGBHex) {
                        // Copy to clipboard
                        navigator.clipboard.writeText(result.sRGBHex).then(() => {
                            showToast(`Color ${result.sRGBHex} copied to clipboard!`, 'success');
                        });
                    }
                }).catch(e => console.log('Eyedropper cancelled'));
            } else if (window.EyeDropper) {
                // Direct browser API
                const eyeDropper = new EyeDropper();
                eyeDropper.open().then(result => {
                    navigator.clipboard.writeText(result.sRGBHex).then(() => {
                        showToast(`Color ${result.sRGBHex} copied to clipboard!`, 'success');
                    });
                }).catch(e => console.log('Eyedropper cancelled'));
            } else {
                alert('Eyedropper is not supported in this browser. Try Chrome or Edge.');
            }
        };

        // Export Options function
        window.openExportOptions = function() {
            if (typeof EnhancedExport !== 'undefined' && EnhancedExport.renderPanel) {
                let modal = document.getElementById('exportOptionsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'exportOptionsModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 800px; max-height: 85vh;">
                            <div class="modal-header">
                                <h3>Export Options</h3>
                                <button class="modal-close" onclick="document.getElementById('exportOptionsModal').style.display='none'">&times;</button>
                            </div>
                            <div class="modal-body" id="exportOptionsContent" style="overflow-y: auto; max-height: 65vh;"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    const canvas = document.getElementById('brochureCanvas');
                    EnhancedExport.renderPanel(document.getElementById('exportOptionsContent'), canvas);
                }
                modal.style.display = 'flex';
            } else {
                console.warn('EnhancedExport not available');
                alert('Export options are loading. Please try again in a moment.');
            }
        };

        // Quick QR Code function
        window.addQRCodeQuick = function() {
            if (typeof ElementsLibrary !== 'undefined' && ElementsLibrary.addToCurrentPage) {
                ElementsLibrary.addToCurrentPage('qrcode', '', '');
                showToast('QR Code added to page!', 'success');
            } else if (typeof addQRCodeToCurrentPage === 'function') {
                addQRCodeToCurrentPage();
                showToast('QR Code added to page!', 'success');
            } else {
                alert('QR Code feature is loading. Please try again in a moment.');
            }
        };

        // Brand Kit function
        window.openBrandKit = function() {
            if (typeof BrandKit !== 'undefined' && BrandKit.renderPanel) {
                let modal = document.getElementById('brandKitModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'brandKitModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 500px;">
                            <div class="modal-header">
                                <h3>Brand Kit</h3>
                                <button class="modal-close" onclick="document.getElementById('brandKitModal').style.display='none'">&times;</button>
                            </div>
                            <div class="modal-body" id="brandKitContent"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    BrandKit.renderPanel(document.getElementById('brandKitContent'));
                }
                modal.style.display = 'flex';
            } else {
                console.warn('BrandKit not available');
                alert('Brand Kit feature is loading. Please try again in a moment.');
            }
        };

        // Magic Resize function
        window.openMagicResize = function() {
            if (typeof MagicResize !== 'undefined' && MagicResize.showModal) {
                // MagicResize exports showModal(), not showPanel()
                MagicResize.showModal();
            } else {
                console.warn('MagicResize not available');
                alert('Magic Resize feature is loading. Please try again in a moment.');
            }
        };

        // Stock Photos function
        window.openStockPhotos = function() {
            if (typeof StockPhotos !== 'undefined' && StockPhotos.showPanel) {
                StockPhotos.showPanel();
            } else if (typeof StockPhotos !== 'undefined' && StockPhotos.renderPanel) {
                // Create a modal for stock photos
                let modal = document.getElementById('stockPhotosModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'stockPhotosModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
                            <div class="modal-header">
                                <h3>Free Stock Photos</h3>
                                <button class="modal-close" onclick="document.getElementById('stockPhotosModal').style.display='none'">&times;</button>
                            </div>
                            <div class="modal-body" id="stockPhotosContent" style="overflow-y: auto; max-height: 60vh;"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    StockPhotos.renderPanel(document.getElementById('stockPhotosContent'));
                }
                modal.style.display = 'flex';
            } else {
                console.warn('StockPhotos not available');
                alert('Stock photos feature is loading. Please try again in a moment.');
            }
        };

        // Background Removal function
        window.openBackgroundRemoval = function() {
            if (typeof BackgroundRemoval !== 'undefined' && BackgroundRemoval.showModal) {
                BackgroundRemoval.showModal(window.selectedImageElement);
            } else {
                console.warn('BackgroundRemoval not available');
                alert('Background removal feature is loading. Please try again in a moment.');
            }
        };

        // Photo Effects function
        window.openPhotoEffects = function() {
            if (typeof PhotoEffects !== 'undefined' && PhotoEffects.show) {
                PhotoEffects.show(window.selectedImageElement);
            } else if (typeof PhotoEffects !== 'undefined') {
                // Create effects panel if show method doesn't exist
                let modal = document.getElementById('photoEffectsModal');
                if (!modal) {
                    const presets = PhotoEffects.getAllPresets ? PhotoEffects.getAllPresets() : [];
                    modal = document.createElement('div');
                    modal.id = 'photoEffectsModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 700px;">
                            <div class="modal-header">
                                <h3>Photo Effects & Filters (40+ Presets)</h3>
                                <button class="modal-close" onclick="document.getElementById('photoEffectsModal').style.display='none'">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="effects-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                                    ${presets.map(p => `
                                        <div class="effect-preset" onclick="PhotoEffects.applyPreset && PhotoEffects.applyPreset(window.selectedImageElement, '${p.id || p}')"
                                             style="padding: 10px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; text-align: center;">
                                            <div style="font-size: 12px;">${p.name || p}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                modal.style.display = 'flex';
            } else {
                console.warn('PhotoEffects not available');
                alert('Photo effects feature is loading. Please try again in a moment.');
            }
        };

        // Image Crop function
        window.openImageCrop = function() {
            if (window.selectedImageElement) {
                // First select the image in the ImageEditor
                if (typeof selectImage === 'function') {
                    selectImage(window.selectedImageElement);
                }
                // Then toggle crop mode
                if (typeof toggleCropMode === 'function') {
                    setTimeout(() => toggleCropMode(), 100);
                } else {
                    console.warn('toggleCropMode not available');
                    alert('Click on an image to access crop mode in the Image Settings panel.');
                }
            } else {
                alert('Please select an image first by clicking on it.');
            }
        };

        // Flip Image function
        window.flipSelectedImage = function() {
            if (window.selectedImageElement) {
                const currentTransform = window.selectedImageElement.style.transform || '';
                if (currentTransform.includes('scaleX(-1)')) {
                    window.selectedImageElement.style.transform = currentTransform.replace('scaleX(-1)', 'scaleX(1)');
                } else {
                    window.selectedImageElement.style.transform = currentTransform + ' scaleX(-1)';
                }
                if (typeof saveToHistory === 'function') {
                    saveToHistory('flip image');
                }
            }
        };

        // Canvas Grid Toggle
        window.toggleCanvasGrid = function(show) {
            const canvas = document.getElementById('brochure-canvas');
            if (!canvas) return;

            let gridOverlay = document.getElementById('canvasGridOverlay');

            if (show) {
                if (!gridOverlay) {
                    gridOverlay = document.createElement('div');
                    gridOverlay.id = 'canvasGridOverlay';
                    gridOverlay.style.cssText = `
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        pointer-events: none;
                        z-index: 9998;
                        background-image:
                            linear-gradient(to right, rgba(200, 200, 200, 0.3) 1px, transparent 1px),
                            linear-gradient(to bottom, rgba(200, 200, 200, 0.3) 1px, transparent 1px);
                        background-size: 20px 20px;
                    `;
                    canvas.style.position = 'relative';
                    canvas.appendChild(gridOverlay);
                }
                gridOverlay.style.display = 'block';
            } else {
                if (gridOverlay) {
                    gridOverlay.style.display = 'none';
                }
            }
        };

        // Property Tools Functions
        window.openPropertyBadges = function() {
            if (typeof BritishBadges !== 'undefined' && BritishBadges.renderPanel) {
                // Create modal for badges
                let modal = document.getElementById('badgesModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'badgesModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="width: 600px; max-height: 80vh; overflow-y: auto;">
                            <div class="modal-header">
                                <h2>Property Badges</h2>
                                <button class="modal-close" onclick="document.getElementById('badgesModal').classList.remove('visible')">&times;</button>
                            </div>
                            <div class="modal-body" id="badgesPanelContent" style="padding: 20px;"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                BritishBadges.renderPanel('badgesPanelContent');
                modal.classList.add('visible');
            } else {
                alert('Property Badges module is loading. Please try again.');
            }
        };

        window.openPropertyCharts = function() {
            if (typeof PropertyCharts !== 'undefined' && PropertyCharts.renderPanel) {
                let modal = document.getElementById('chartsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'chartsModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="width: 700px; max-height: 80vh; overflow-y: auto;">
                            <div class="modal-header">
                                <h2>Property Charts</h2>
                                <button class="modal-close" onclick="document.getElementById('chartsModal').classList.remove('visible')">&times;</button>
                            </div>
                            <div class="modal-body" id="chartsPanelContent" style="padding: 20px;"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                PropertyCharts.renderPanel('chartsPanelContent');
                modal.classList.add('visible');
            } else {
                alert('Property Charts module is loading. Please try again.');
            }
        };

        window.openAIContent = function() {
            if (typeof AIContent !== 'undefined' && AIContent.showModal) {
                AIContent.showModal();
            } else {
                alert('AI Content module is loading. Please try again.');
            }
        };

        window.openPropertyGraphics = function() {
            if (typeof PropertyGraphics !== 'undefined' && PropertyGraphics.showPanel) {
                PropertyGraphics.showPanel();
            } else {
                alert('Property Graphics module is loading. Please try again.');
            }
        };

        // Element Style Panel Functions
        let currentStyledElement = null;

        window.openElementStylePanel = function(element) {
            currentStyledElement = element;
            const panel = document.getElementById('elementStylePanel');
            if (!panel) return;

            // Position panel near element
            const rect = element.getBoundingClientRect();
            panel.style.position = 'fixed';
            panel.style.left = Math.min(rect.right + 10, window.innerWidth - 260) + 'px';
            panel.style.top = Math.max(rect.top, 60) + 'px';
            panel.style.display = 'block';

            // Load current element values
            loadElementStyleValues(element);
        };

        window.closeElementStylePanel = function() {
            const panel = document.getElementById('elementStylePanel');
            if (panel) panel.style.display = 'none';
            currentStyledElement = null;
        };

        window.openStylePanelForSelected = function() {
            if (typeof EditorState !== 'undefined') {
                const selected = EditorState.selectedElement ||
                                (EditorState.selectedElements && EditorState.selectedElements[0]);
                if (selected) {
                    openElementStylePanel(selected);
                } else {
                    alert('Please select an element first to style it.');
                }
            } else {
                alert('Please select an element first to style it.');
            }
        };

        function loadElementStyleValues(element) {
            const computedStyle = window.getComputedStyle(element);

            // Opacity
            const opacity = parseFloat(computedStyle.opacity) * 100;
            document.getElementById('elementOpacity').value = opacity;
            document.getElementById('opacityValue').textContent = Math.round(opacity) + '%';

            // Shadow
            const shadow = computedStyle.boxShadow;
            const hasShadow = shadow && shadow !== 'none';
            document.getElementById('shadowEnabled').checked = hasShadow;
            document.getElementById('shadowBlur').disabled = !hasShadow;
            document.getElementById('shadowColor').disabled = !hasShadow;

            // Border
            const borderWidth = parseInt(computedStyle.borderWidth) || 0;
            document.getElementById('borderWidth').value = borderWidth;
            document.getElementById('borderStyle').value = computedStyle.borderStyle || 'solid';

            // Border radius
            const radius = parseInt(computedStyle.borderRadius) || 0;
            document.getElementById('borderRadius').value = radius;
            document.getElementById('cornersValue').textContent = radius + 'px';
        }

        window.setElementOpacity = function(value) {
            if (!currentStyledElement) return;
            currentStyledElement.style.opacity = value / 100;
            document.getElementById('opacityValue').textContent = value + '%';
            if (typeof saveToHistory === 'function') {
                saveToHistory('change opacity');
            }
        };

        window.toggleElementShadow = function(enabled) {
            document.getElementById('shadowBlur').disabled = !enabled;
            document.getElementById('shadowColor').disabled = !enabled;

            if (!currentStyledElement) return;

            if (enabled) {
                updateElementShadow();
            } else {
                currentStyledElement.style.boxShadow = 'none';
            }
            if (typeof saveToHistory === 'function') {
                saveToHistory('toggle shadow');
            }
        };

        window.updateElementShadow = function() {
            if (!currentStyledElement) return;
            if (!document.getElementById('shadowEnabled').checked) return;

            const blur = document.getElementById('shadowBlur').value;
            const color = document.getElementById('shadowColor').value;
            currentStyledElement.style.boxShadow = `0 4px ${blur}px ${color}40`;
            if (typeof saveToHistory === 'function') {
                saveToHistory('update shadow');
            }
        };

        window.updateElementBorder = function() {
            if (!currentStyledElement) return;

            const width = document.getElementById('borderWidth').value;
            const style = document.getElementById('borderStyle').value;
            const color = document.getElementById('borderColor').value;

            if (parseInt(width) > 0) {
                currentStyledElement.style.border = `${width}px ${style} ${color}`;
            } else {
                currentStyledElement.style.border = 'none';
            }
            if (typeof saveToHistory === 'function') {
                saveToHistory('update border');
            }
        };

        window.setElementCorners = function(value) {
            if (!currentStyledElement) return;
            currentStyledElement.style.borderRadius = value + 'px';
            document.getElementById('cornersValue').textContent = value + 'px';
            if (typeof saveToHistory === 'function') {
                saveToHistory('change corners');
            }
        };

        // Canvas Rulers Toggle
        window.toggleCanvasRulers = function(show) {
            const canvasArea = document.querySelector('.canvas-area');
            if (!canvasArea) return;

            let rulerContainer = document.getElementById('canvasRulers');

            if (show) {
                if (!rulerContainer) {
                    rulerContainer = document.createElement('div');
                    rulerContainer.id = 'canvasRulers';

                    // Add ruler styles
                    const styles = document.createElement('style');
                    styles.id = 'ruler-styles';
                    styles.textContent = `
                        #canvasRulers {
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            pointer-events: none;
                            z-index: 9997;
                        }
                        .ruler-horizontal {
                            position: absolute;
                            top: 0;
                            left: 20px;
                            right: 0;
                            height: 20px;
                            background: #f5f5f5;
                            border-bottom: 1px solid #ddd;
                            overflow: hidden;
                        }
                        .ruler-vertical {
                            position: absolute;
                            top: 20px;
                            left: 0;
                            width: 20px;
                            bottom: 0;
                            background: #f5f5f5;
                            border-right: 1px solid #ddd;
                            overflow: hidden;
                        }
                        .ruler-corner {
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 20px;
                            height: 20px;
                            background: #e8e8e8;
                            border-right: 1px solid #ddd;
                            border-bottom: 1px solid #ddd;
                        }
                        .ruler-tick {
                            position: absolute;
                            background: #999;
                        }
                        .ruler-horizontal .ruler-tick {
                            width: 1px;
                            bottom: 0;
                        }
                        .ruler-vertical .ruler-tick {
                            height: 1px;
                            right: 0;
                        }
                        .ruler-tick.major {
                            background: #666;
                        }
                        .ruler-label {
                            position: absolute;
                            font-size: 8px;
                            color: #666;
                            font-family: monospace;
                        }
                        .ruler-horizontal .ruler-label {
                            bottom: 3px;
                        }
                        .ruler-vertical .ruler-label {
                            right: 3px;
                            transform: rotate(-90deg);
                            transform-origin: right bottom;
                            white-space: nowrap;
                        }
                    `;
                    if (!document.getElementById('ruler-styles')) {
                        document.head.appendChild(styles);
                    }

                    // Create ruler elements
                    const hRuler = document.createElement('div');
                    hRuler.className = 'ruler-horizontal';

                    const vRuler = document.createElement('div');
                    vRuler.className = 'ruler-vertical';

                    const corner = document.createElement('div');
                    corner.className = 'ruler-corner';

                    // Generate tick marks (every 10px, labels every 100px)
                    const canvas = document.getElementById('brochure-canvas');
                    const width = canvas ? canvas.offsetWidth : 800;
                    const height = canvas ? canvas.offsetHeight : 1200;

                    // Horizontal ticks
                    for (let i = 0; i <= width; i += 10) {
                        const tick = document.createElement('div');
                        tick.className = 'ruler-tick' + (i % 100 === 0 ? ' major' : '');
                        tick.style.left = i + 'px';
                        tick.style.height = (i % 100 === 0 ? '10px' : i % 50 === 0 ? '7px' : '4px');
                        hRuler.appendChild(tick);

                        if (i % 100 === 0 && i > 0) {
                            const label = document.createElement('span');
                            label.className = 'ruler-label';
                            label.style.left = (i + 2) + 'px';
                            label.textContent = i;
                            hRuler.appendChild(label);
                        }
                    }

                    // Vertical ticks
                    for (let i = 0; i <= height; i += 10) {
                        const tick = document.createElement('div');
                        tick.className = 'ruler-tick' + (i % 100 === 0 ? ' major' : '');
                        tick.style.top = i + 'px';
                        tick.style.width = (i % 100 === 0 ? '10px' : i % 50 === 0 ? '7px' : '4px');
                        vRuler.appendChild(tick);

                        if (i % 100 === 0 && i > 0) {
                            const label = document.createElement('span');
                            label.className = 'ruler-label';
                            label.style.top = (i + 12) + 'px';
                            label.textContent = i;
                            vRuler.appendChild(label);
                        }
                    }

                    rulerContainer.appendChild(corner);
                    rulerContainer.appendChild(hRuler);
                    rulerContainer.appendChild(vRuler);

                    canvasArea.style.position = 'relative';
                    canvasArea.insertBefore(rulerContainer, canvasArea.firstChild);
                }
                rulerContainer.style.display = 'block';
            } else {
                if (rulerContainer) {
                    rulerContainer.style.display = 'none';
                }
            }
        };

        // Zoom from dropdown
        window.setZoomFromDropdown = function(value) {
            const zoomLevel = parseFloat(value);
            if (isNaN(zoomLevel)) return;

            if (typeof setZoom === 'function') {
                setZoom(zoomLevel);
            } else {
                // Fallback if setZoom not available
                if (typeof EditorState !== 'undefined') {
                    EditorState.zoomLevel = zoomLevel;
                }
                const canvas = document.getElementById('brochure-canvas');
                if (canvas) {
                    canvas.style.transform = `scale(${zoomLevel})`;
                    canvas.style.transformOrigin = 'center top';
                }
            }
        };

        // Update dropdown when zoom changes (integrate with existing setZoom)
        (function() {
            const originalSetZoom = window.setZoom;
            if (originalSetZoom) {
                window.setZoom = function(level) {
                    originalSetZoom(level);
                    updateZoomDropdown(level);
                };
            }

            // Also patch via interval to catch initialization
            setTimeout(() => {
                if (typeof setZoom === 'function' && !window._zoomPatched) {
                    window._zoomPatched = true;
                    const origFn = window.setZoom;
                    window.setZoom = function(level) {
                        origFn(level);
                        updateZoomDropdown(level);
                    };
                }
            }, 2000);
        })();

        function updateZoomDropdown(level) {
            const dropdown = document.getElementById('zoomLevelSelect');
            if (!dropdown) return;

            // Find closest option
            const options = Array.from(dropdown.options);
            let closest = options[0];
            let closestDiff = Math.abs(parseFloat(options[0].value) - level);

            options.forEach(opt => {
                const diff = Math.abs(parseFloat(opt.value) - level);
                if (diff < closestDiff) {
                    closest = opt;
                    closestDiff = diff;
                }
            });

            // If exact match within 1%, select it
            if (closestDiff < 0.01) {
                dropdown.value = closest.value;
            } else {
                // Show actual percentage as custom
                // Check if we already have a custom option
                let customOpt = dropdown.querySelector('option[data-custom="true"]');
                if (!customOpt) {
                    customOpt = document.createElement('option');
                    customOpt.dataset.custom = 'true';
                    dropdown.appendChild(customOpt);
                }
                customOpt.value = level;
                customOpt.textContent = Math.round(level * 100) + '%';
                dropdown.value = level;
            }
        }

        // Track selected image element for image tools
        window.selectedImageElement = null;

        // Show image tools when clicking on images
        document.addEventListener('click', (e) => {
            const img = e.target.closest('img, .brochure-image, .gallery-image');
            const imageToolbar = document.getElementById('imageToolsToolbar');

            if (img && img.tagName === 'IMG') {
                window.selectedImageElement = img;
                if (imageToolbar) {
                    imageToolbar.style.display = 'flex';
                    const rect = img.getBoundingClientRect();
                    imageToolbar.style.left = `${rect.left}px`;
                    imageToolbar.style.top = `${rect.top - 50}px`;
                }
            } else if (!e.target.closest('#imageToolsToolbar')) {
                window.selectedImageElement = null;
                if (imageToolbar) {
                    imageToolbar.style.display = 'none';
                }
            }
        });

        // Line Height and Letter Spacing functions
        window.setTextLineHeight = function(value) {
            if (!activeTextElement) return;

            activeTextElement.style.lineHeight = value;

            // Update display
            const valueDisplay = document.getElementById('lineHeightValue');
            if (valueDisplay) valueDisplay.textContent = value;

            // Save to history
            if (typeof saveToHistory === 'function') {
                saveToHistory('change line height');
            }
        };

        window.setTextLetterSpacing = function(value) {
            if (!activeTextElement) return;

            activeTextElement.style.letterSpacing = value + 'px';

            // Update display
            const valueDisplay = document.getElementById('letterSpacingValue');
            if (valueDisplay) valueDisplay.textContent = value + 'px';

            // Save to history
            if (typeof saveToHistory === 'function') {
                saveToHistory('change letter spacing');
            }
        };

        // Animations function - opens animation panel for selected element
        window.openAnimations = function() {
            const selected = (typeof EditorState !== 'undefined') ?
                (EditorState.selectedElement || (EditorState.selectedElements && EditorState.selectedElements[0])) :
                document.querySelector('.canvas-element.selected, .design-element.selected');

            if (!selected) {
                alert('Please select an element first to add animations.');
                return;
            }

            if (typeof Animations !== 'undefined' && Animations.showPanel) {
                Animations.showPanel(selected);
            } else if (typeof AnimationSystem !== 'undefined' && AnimationSystem.showPanel) {
                AnimationSystem.showPanel(selected);
            } else {
                // Create a simple animation panel if main module not loaded
                let modal = document.getElementById('animationsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'animationsModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 500px;">
                            <div class="modal-header">
                                <h3>Element Animations</h3>
                                <button class="modal-close" onclick="document.getElementById('animationsModal').classList.remove('visible')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p style="margin-bottom: 15px;">Choose an entrance animation:</p>
                                <div class="animations-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                    <button class="animation-btn" onclick="applySimpleAnimation('fadeIn')" style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <span style="display: block; font-size: 24px; margin-bottom: 5px;">‚ú®</span>
                                        Fade In
                                    </button>
                                    <button class="animation-btn" onclick="applySimpleAnimation('slideUp')" style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <span style="display: block; font-size: 24px; margin-bottom: 5px;">‚¨ÜÔ∏è</span>
                                        Slide Up
                                    </button>
                                    <button class="animation-btn" onclick="applySimpleAnimation('slideDown')" style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <span style="display: block; font-size: 24px; margin-bottom: 5px;">‚¨áÔ∏è</span>
                                        Slide Down
                                    </button>
                                    <button class="animation-btn" onclick="applySimpleAnimation('slideLeft')" style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <span style="display: block; font-size: 24px; margin-bottom: 5px;">‚¨ÖÔ∏è</span>
                                        Slide Left
                                    </button>
                                    <button class="animation-btn" onclick="applySimpleAnimation('slideRight')" style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <span style="display: block; font-size: 24px; margin-bottom: 5px;">‚û°Ô∏è</span>
                                        Slide Right
                                    </button>
                                    <button class="animation-btn" onclick="applySimpleAnimation('zoomIn')" style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <span style="display: block; font-size: 24px; margin-bottom: 5px;">üîç</span>
                                        Zoom In
                                    </button>
                                    <button class="animation-btn" onclick="applySimpleAnimation('bounce')" style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <span style="display: block; font-size: 24px; margin-bottom: 5px;">‚ö°</span>
                                        Bounce
                                    </button>
                                    <button class="animation-btn" onclick="applySimpleAnimation('rotate')" style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <span style="display: block; font-size: 24px; margin-bottom: 5px;">üîÑ</span>
                                        Rotate
                                    </button>
                                    <button class="animation-btn" onclick="removeSimpleAnimation()" style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; background: #ffeeee;">
                                        <span style="display: block; font-size: 24px; margin-bottom: 5px;">‚ùå</span>
                                        Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                modal.classList.add('visible');
            }
        };

        // Simple animation helper
        window.applySimpleAnimation = function(type) {
            const selected = (typeof EditorState !== 'undefined') ?
                (EditorState.selectedElement || (EditorState.selectedElements && EditorState.selectedElements[0])) :
                document.querySelector('.canvas-element.selected, .design-element.selected');

            if (!selected) return;

            // Remove existing animations
            selected.style.animation = '';
            selected.classList.remove('animated');

            // Add animation keyframes if not present
            if (!document.getElementById('simpleAnimationStyles')) {
                const style = document.createElement('style');
                style.id = 'simpleAnimationStyles';
                style.textContent = `
                    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                    @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                    @keyframes slideLeft { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
                    @keyframes slideRight { from { transform: translateX(-50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
                    @keyframes zoomIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
                    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
                    @keyframes rotate { from { transform: rotate(-180deg); opacity: 0; } to { transform: rotate(0); opacity: 1; } }
                `;
                document.head.appendChild(style);
            }

            // Apply animation
            selected.style.animation = `${type} 0.6s ease-out forwards`;
            selected.dataset.animation = type;

            if (typeof saveToHistory === 'function') {
                saveToHistory('add animation');
            }
            if (typeof showToast === 'function') {
                showToast(`Applied ${type} animation`);
            }

            // Close modal
            const modal = document.getElementById('animationsModal');
            if (modal) modal.classList.remove('visible');
        };

        window.removeSimpleAnimation = function() {
            const selected = (typeof EditorState !== 'undefined') ?
                (EditorState.selectedElement || (EditorState.selectedElements && EditorState.selectedElements[0])) :
                document.querySelector('.canvas-element.selected, .design-element.selected');

            if (!selected) return;

            selected.style.animation = '';
            delete selected.dataset.animation;

            if (typeof saveToHistory === 'function') {
                saveToHistory('remove animation');
            }
            if (typeof showToast === 'function') {
                showToast('Animation removed');
            }

            // Close modal
            const modal = document.getElementById('animationsModal');
            if (modal) modal.classList.remove('visible');
        };

        // Onboarding Tour function
        window.startOnboardingTour = function() {
            if (typeof Onboarding !== 'undefined' && Onboarding.start) {
                // Reset and start fresh
                if (Onboarding.reset) Onboarding.reset();
                Onboarding.start();
            } else {
                // Simple walkthrough if Onboarding module not loaded
                const steps = [
                    { title: 'Welcome!', text: 'This editor lets you create professional brochures. Let me show you around.' },
                    { title: 'Photos Panel', text: 'Upload your property photos here or browse free stock images.' },
                    { title: 'Canvas', text: 'This is where you design. Drag elements, resize, and position them.' },
                    { title: 'Elements Panel', text: 'Add shapes, icons, text, and QR codes from the right panel.' },
                    { title: 'Layers', text: 'Control element stacking order in the Layers tab.' },
                    { title: 'Templates', text: 'Choose from pre-designed templates to get started quickly.' },
                    { title: 'Export', text: 'When done, export as PDF or image from the top menu.' }
                ];

                let currentStep = 0;

                function showStep(index) {
                    if (index >= steps.length) {
                        alert('Tour complete! Start designing your brochure.');
                        return;
                    }

                    const step = steps[index];
                    const proceed = confirm(`${step.title}\n\n${step.text}\n\nClick OK for next tip, Cancel to end tour.`);

                    if (proceed) {
                        showStep(index + 1);
                    }
                }

                showStep(0);
            }
        };

        // Backgrounds Library function
        window.openBackgrounds = function() {
            if (typeof BackgroundsLibrary !== 'undefined' && BackgroundsLibrary.showBackgroundPanel) {
                // Get the current page canvas
                const canvas = document.getElementById('brochure-canvas') ||
                              document.querySelector('.brochure-canvas') ||
                              document.querySelector('.canvas-page');
                BackgroundsLibrary.showBackgroundPanel(canvas);
            } else {
                // Create a simple background selector
                let modal = document.getElementById('backgroundsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'backgroundsModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h3>Page Backgrounds</h3>
                                <button class="modal-close" onclick="document.getElementById('backgroundsModal').classList.remove('visible')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div style="margin-bottom: 15px;">
                                    <strong>Solid Colors</strong>
                                    <div class="color-swatches" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; margin-top: 10px;">
                                        ${['#FFFFFF', '#F5F5F5', '#E0E0E0', '#1A1A2E', '#16213E', '#0F3460', '#E94560', '#00ADB5',
                                          '#FFF8E7', '#FFE4C4', '#FFE4E1', '#E6E6FA', '#F0FFF0', '#E0FFFF', '#FFF0F5', '#FFFACD'].map(c => `
                                            <button onclick="applyPageBackground('${c}')" style="width: 40px; height: 40px; background: ${c}; border: 2px solid #ddd; border-radius: 6px; cursor: pointer;"></button>
                                        `).join('')}
                                    </div>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>Gradients</strong>
                                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px;">
                                        ${[
                                            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                                            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                                            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                                            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                                            'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                                            'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)',
                                            'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                                        ].map(g => `
                                            <button onclick="applyPageBackground('${g}')" style="width: 100%; height: 50px; background: ${g}; border: 2px solid #ddd; border-radius: 6px; cursor: pointer;"></button>
                                        `).join('')}
                                    </div>
                                </div>
                                <div>
                                    <strong>Custom Color</strong>
                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <input type="color" id="customBgColor" value="#FFFFFF" style="width: 50px; height: 40px; cursor: pointer;">
                                        <button onclick="applyPageBackground(document.getElementById('customBgColor').value)" class="action-btn primary" style="flex: 1;">Apply Custom Color</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                modal.classList.add('visible');
            }
        };

        window.applyPageBackground = function(background) {
            const canvas = document.getElementById('brochure-canvas') ||
                          document.querySelector('.brochure-canvas') ||
                          document.querySelector('.canvas-page');
            if (!canvas) return;

            if (background.includes('gradient')) {
                canvas.style.background = background;
            } else {
                canvas.style.backgroundColor = background;
                canvas.style.backgroundImage = 'none';
            }

            if (typeof saveToHistory === 'function') {
                saveToHistory('change background');
            }
            if (typeof showToast === 'function') {
                showToast('Background applied');
            }

            // Close modal
            const modal = document.getElementById('backgroundsModal');
            if (modal) modal.classList.remove('visible');
        };

        // Photo Frames function
        window.openPhotoFrames = function() {
            const selectedImage = window.selectedImageElement ||
                document.querySelector('.canvas-element.selected img, .design-element.selected img');

            if (!selectedImage) {
                alert('Please select an image first to apply frames.');
                return;
            }

            if (typeof PhotoFrames !== 'undefined' && PhotoFrames.showFramePanel) {
                PhotoFrames.showFramePanel(selectedImage);
            } else {
                // Create a simple frame selector
                let modal = document.getElementById('framesModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'framesModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 500px;">
                            <div class="modal-header">
                                <h3>Photo Frames & Shapes</h3>
                                <button class="modal-close" onclick="document.getElementById('framesModal').classList.remove('visible')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p style="margin-bottom: 15px;">Choose a shape for your image:</p>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                                    <button onclick="applyImageShape('none')" style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <div style="font-size: 24px;">‚¨ú</div>
                                        <small>Square</small>
                                    </button>
                                    <button onclick="applyImageShape('circle')" style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <div style="font-size: 24px;">‚≠ï</div>
                                        <small>Circle</small>
                                    </button>
                                    <button onclick="applyImageShape('rounded')" style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <div style="font-size: 24px;">üî≤</div>
                                        <small>Rounded</small>
                                    </button>
                                    <button onclick="applyImageShape('oval')" style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <div style="font-size: 24px;">üíä</div>
                                        <small>Oval</small>
                                    </button>
                                    <button onclick="applyImageShape('diamond')" style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <div style="font-size: 24px;">üíé</div>
                                        <small>Diamond</small>
                                    </button>
                                    <button onclick="applyImageShape('hexagon')" style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <div style="font-size: 24px;">‚¨°</div>
                                        <small>Hexagon</small>
                                    </button>
                                    <button onclick="applyImageShape('star')" style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <div style="font-size: 24px;">‚≠ê</div>
                                        <small>Star</small>
                                    </button>
                                    <button onclick="applyImageShape('heart')" style="padding: 20px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                        <div style="font-size: 24px;">‚ù§Ô∏è</div>
                                        <small>Heart</small>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                modal.classList.add('visible');
            }
        };

        window.applyImageShape = function(shape) {
            const img = window.selectedImageElement ||
                document.querySelector('.canvas-element.selected img, .design-element.selected img');
            if (!img) return;

            const container = img.closest('.canvas-element') || img.closest('.design-element') || img.parentElement;

            // Reset previous shape
            img.style.clipPath = '';
            img.style.borderRadius = '';
            container.style.clipPath = '';
            container.style.borderRadius = '';

            switch(shape) {
                case 'circle':
                    img.style.borderRadius = '50%';
                    container.style.borderRadius = '50%';
                    break;
                case 'rounded':
                    img.style.borderRadius = '20px';
                    container.style.borderRadius = '20px';
                    break;
                case 'oval':
                    img.style.borderRadius = '50% / 35%';
                    container.style.borderRadius = '50% / 35%';
                    break;
                case 'diamond':
                    img.style.clipPath = 'polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)';
                    break;
                case 'hexagon':
                    img.style.clipPath = 'polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)';
                    break;
                case 'star':
                    img.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
                    break;
                case 'heart':
                    img.style.clipPath = 'path("M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z")';
                    break;
                case 'none':
                default:
                    // Already reset
                    break;
            }

            if (typeof saveToHistory === 'function') {
                saveToHistory('change image shape');
            }
            if (typeof showToast === 'function') {
                showToast(`Applied ${shape} shape`);
            }

            // Close modal
            const modal = document.getElementById('framesModal');
            if (modal) modal.classList.remove('visible');
        };

        // Share Modal function
        window.openShareModal = function() {
            if (typeof Sharing !== 'undefined' && Sharing.renderShareModal) {
                Sharing.renderShareModal();
            } else {
                // Create a simple share modal
                let modal = document.getElementById('shareModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'shareModal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 500px;">
                            <div class="modal-header">
                                <h3>Share Your Design</h3>
                                <button class="modal-close" onclick="document.getElementById('shareModal').classList.remove('visible')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Share Link</label>
                                    <div style="display: flex; gap: 10px;">
                                        <input type="text" id="shareLink" value="${window.location.href}" readonly style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                        <button onclick="copyShareLink()" class="action-btn primary">Copy</button>
                                    </div>
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Share via</label>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                        <button onclick="shareVia('email')" style="padding: 12px 20px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                            üìß Email
                                        </button>
                                        <button onclick="shareVia('whatsapp')" style="padding: 12px 20px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; background: #25D366; color: white;">
                                            üí¨ WhatsApp
                                        </button>
                                        <button onclick="shareVia('linkedin')" style="padding: 12px 20px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; background: #0077B5; color: white;">
                                            üíº LinkedIn
                                        </button>
                                        <button onclick="shareVia('facebook')" style="padding: 12px 20px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; background: #1877F2; color: white;">
                                            üìò Facebook
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Permissions</label>
                                    <select style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                        <option value="view">Can View</option>
                                        <option value="comment">Can Comment</option>
                                        <option value="edit">Can Edit</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                modal.classList.add('visible');
            }
        };

        window.copyShareLink = function() {
            const linkInput = document.getElementById('shareLink');
            if (linkInput) {
                linkInput.select();
                document.execCommand('copy');
                if (typeof showToast === 'function') {
                    showToast('Link copied to clipboard');
                } else {
                    alert('Link copied!');
                }
            }
        };

        window.shareVia = function(platform) {
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent(document.title || 'My Brochure Design');
            let shareUrl = '';

            switch(platform) {
                case 'email':
                    shareUrl = `mailto:?subject=${title}&body=Check out my design: ${url}`;
                    break;
                case 'whatsapp':
                    shareUrl = `https://wa.me/?text=${title} ${url}`;
                    break;
                case 'linkedin':
                    shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
                    break;
                case 'facebook':
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
                    break;
            }

            if (shareUrl) {
                window.open(shareUrl, '_blank', 'width=600,height=400');
            }

            // Close modal
            const modal = document.getElementById('shareModal');
            if (modal) modal.classList.remove('visible');
        };

        // Update sliders when text element is selected
        const originalShowToolbar = window.showTextFormatToolbar || function() {};
        window.showTextFormatToolbar = function(element) {
            originalShowToolbar(element);

            // Read current line-height
            const computedStyle = window.getComputedStyle(element);
            let lineHeight = parseFloat(computedStyle.lineHeight);
            const fontSize = parseFloat(computedStyle.fontSize);
            if (!isNaN(lineHeight) && !isNaN(fontSize)) {
                lineHeight = lineHeight / fontSize;
            } else {
                lineHeight = 1.5;
            }

            const lineHeightSlider = document.getElementById('lineHeightSlider');
            const lineHeightValue = document.getElementById('lineHeightValue');
            if (lineHeightSlider) lineHeightSlider.value = lineHeight;
            if (lineHeightValue) lineHeightValue.textContent = lineHeight.toFixed(1);

            // Read current letter-spacing
            let letterSpacing = parseFloat(computedStyle.letterSpacing) || 0;
            const letterSpacingSlider = document.getElementById('letterSpacingSlider');
            const letterSpacingValue = document.getElementById('letterSpacingValue');
            if (letterSpacingSlider) letterSpacingSlider.value = letterSpacing;
            if (letterSpacingValue) letterSpacingValue.textContent = letterSpacing + 'px';
        };

        // Social Media Repurpose function
        window.openSocialMediaRepurpose = function() {
            // Try to use the existing repurpose modal from social_media_repurpose.js
            const existingModal = document.getElementById('repurposeModal');
            if (existingModal) {
                existingModal.style.display = 'flex';
                // Try to load session data
                if (typeof loadBrochureSessionData === 'function') {
                    loadBrochureSessionData();
                }
                return;
            }

            // If no modal exists, create a comprehensive social media panel
            let modal = document.getElementById('socialMediaModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'socialMediaModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                            <h3 style="margin: 0;">AI Social Media Generator</h3>
                            <button class="modal-close" onclick="document.getElementById('socialMediaModal').classList.remove('visible')" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 20px;">
                            <!-- Platform Selection -->
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 10px;">Select Platform</h4>
                                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; border: 2px solid #667eea; border-radius: 8px; cursor: pointer; background: #f0f0ff;" class="platform-option" data-platform="instagram">
                                        <input type="radio" name="socialPlatform" value="instagram" checked>
                                        <span style="font-size: 20px;">üì∏</span> Instagram
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;" class="platform-option" data-platform="facebook">
                                        <input type="radio" name="socialPlatform" value="facebook">
                                        <span style="font-size: 20px;">üìò</span> Facebook
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer;" class="platform-option" data-platform="twitter">
                                        <input type="radio" name="socialPlatform" value="twitter">
                                        <span style="font-size: 20px;">üê¶</span> X/Twitter
                                    </label>
                                </div>
                            </div>

                            <!-- Generate Button -->
                            <div style="margin-bottom: 20px; text-align: center;">
                                <button id="generateSocialBtn" onclick="generateSocialContent()" style="padding: 15px 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
                                    ‚ú® Generate AI Content
                                </button>
                                <p style="margin-top: 8px; color: #666; font-size: 13px;">Uses Claude AI to create optimized captions and hashtags</p>
                            </div>

                            <!-- Loading State -->
                            <div id="socialLoadingState" style="display: none; text-align: center; padding: 40px;">
                                <div style="width: 50px; height: 50px; border: 4px solid #f0f0f0; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                                <p style="color: #666;">Generating AI-powered content...</p>
                            </div>

                            <!-- Generated Content (hidden initially) -->
                            <div id="socialGeneratedContent" style="display: none;">
                                <!-- Generated Caption -->
                                <div style="margin-bottom: 20px;">
                                    <h4 style="margin-bottom: 10px;">Generated Caption</h4>
                                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                            <span style="font-weight: 600;" id="captionPlatformLabel">Instagram Caption</span>
                                            <button onclick="copyCaption('generated')" style="padding: 5px 10px; border: 1px solid #667eea; border-radius: 4px; background: white; color: #667eea; cursor: pointer;">Copy</button>
                                        </div>
                                        <textarea id="captionGenerated" style="width: 100%; min-height: 120px; border: 1px solid #eee; border-radius: 4px; padding: 10px; resize: vertical; font-family: inherit;"></textarea>
                                    </div>
                                </div>

                                <!-- AI Generated Hashtags -->
                                <div style="margin-bottom: 20px;">
                                    <h4 style="margin-bottom: 10px;">AI-Generated Hashtags</h4>
                                    <div id="hashtagsContainer" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        <!-- Hashtags will be populated by AI -->
                                    </div>
                                    <button onclick="copyAllHashtags()" style="margin-top: 10px; padding: 8px 16px; border: 1px solid #667eea; border-radius: 4px; background: white; color: #667eea; cursor: pointer;">Copy All Hashtags</button>
                                </div>

                                <!-- Property Info Used -->
                                <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                                    <h5 style="margin: 0 0 10px 0; color: #666;">Property Data Used:</h5>
                                    <div id="propertyDataUsed" style="font-size: 13px; color: #888;"></div>
                                </div>
                            </div>

                            <!-- Export Actions -->
                            <div style="display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 20px;">
                                <button onclick="exportForInstagram()" style="padding: 12px 24px; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    üì∏ Export for Instagram
                                </button>
                                <button onclick="exportForFacebook()" style="padding: 12px 24px; background: #1877F2; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    üìò Export for Facebook
                                </button>
                                <button onclick="downloadSocialPack()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    üì¶ Download All
                                </button>
                            </div>
                        </div>
                    </div>
                    <style>
                        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                    </style>
                `;
                document.body.appendChild(modal);

                // Add platform selection listeners
                modal.querySelectorAll('.platform-option').forEach(label => {
                    label.addEventListener('click', function() {
                        modal.querySelectorAll('.platform-option').forEach(l => {
                            l.style.border = '2px solid #ddd';
                            l.style.background = 'white';
                        });
                        this.style.border = '2px solid #667eea';
                        this.style.background = '#f0f0ff';
                    });
                });
            }
            modal.classList.add('visible');
        };

        // Generate social content using real AI API
        window.generateSocialContent = async function() {
            const loadingState = document.getElementById('socialLoadingState');
            const generatedContent = document.getElementById('socialGeneratedContent');
            const generateBtn = document.getElementById('generateSocialBtn');

            // Get selected platform
            const platformRadio = document.querySelector('input[name="socialPlatform"]:checked');
            const platform = platformRadio ? platformRadio.value : 'instagram';

            // Get property data from EditorState
            const property = EditorState.sessionData?.property || {};
            const pages = EditorState.sessionData?.pages || [];

            // Extract description from pages
            let description = '';
            const detailsPage = pages.find(p => p.type === 'details');
            if (detailsPage && detailsPage.content) {
                description = detailsPage.content.description || '';
            }

            // Extract features
            let features = [];
            if (detailsPage && detailsPage.content && detailsPage.content.features) {
                features = detailsPage.content.features;
            }

            // Show loading
            loadingState.style.display = 'block';
            generatedContent.style.display = 'none';
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';

            try {
                // Build form data for the API
                const formData = new URLSearchParams();
                formData.append('property_name', property.address || 'Beautiful Property');
                formData.append('address', property.address || 'Prime Location');
                formData.append('platform', platform);
                formData.append('price', property.price || '');
                formData.append('bedrooms', property.bedrooms || '');
                formData.append('bathrooms', property.bathrooms || '');
                formData.append('property_type', property.propertyType || '');
                formData.append('description', description);
                if (features.length > 0) {
                    formData.append('key_features', JSON.stringify(features));
                }

                // Call the real API
                const response = await fetch('/marketing/social-post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData.toString()
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const result = await response.json();
                console.log('[SocialMedia] AI Response:', result);

                // Update UI with generated content
                const captionTextarea = document.getElementById('captionGenerated');
                const captionLabel = document.getElementById('captionPlatformLabel');
                const hashtagsContainer = document.getElementById('hashtagsContainer');
                const propertyDataDiv = document.getElementById('propertyDataUsed');

                // Set caption
                captionLabel.textContent = `${platform.charAt(0).toUpperCase() + platform.slice(1)} Caption`;
                captionTextarea.value = result.post_text || result.caption || 'Content generated successfully!';

                // Set hashtags
                const hashtags = result.hashtags || [];
                hashtagsContainer.innerHTML = hashtags.map(tag =>
                    `<span class="hashtag-chip" style="padding: 6px 12px; background: #f0f0f0; border-radius: 20px; cursor: pointer;" onclick="copyHashtag(this)">${tag.startsWith('#') ? tag : '#' + tag}</span>`
                ).join('');

                // Show property data used
                propertyDataDiv.innerHTML = `
                    <strong>Address:</strong> ${property.address || 'N/A'} |
                    <strong>Price:</strong> ${property.price || 'N/A'} |
                    <strong>Beds:</strong> ${property.bedrooms || 'N/A'} |
                    <strong>Baths:</strong> ${property.bathrooms || 'N/A'} |
                    <strong>Type:</strong> ${property.propertyType || 'N/A'}
                `;

                // Show generated content
                loadingState.style.display = 'none';
                generatedContent.style.display = 'block';

                showToast('AI content generated successfully!');

            } catch (error) {
                console.error('[SocialMedia] Error:', error);
                loadingState.style.display = 'none';

                // Show fallback content with property data
                generatedContent.style.display = 'block';
                const captionTextarea = document.getElementById('captionGenerated');
                const hashtagsContainer = document.getElementById('hashtagsContainer');
                const propertyDataDiv = document.getElementById('propertyDataUsed');

                // Generate fallback content based on property data
                const fallbackCaption = generateFallbackCaption(property, platform);
                captionTextarea.value = fallbackCaption;

                // Generate dynamic hashtags based on property
                const dynamicHashtags = generateDynamicHashtags(property);
                hashtagsContainer.innerHTML = dynamicHashtags.map(tag =>
                    `<span class="hashtag-chip" style="padding: 6px 12px; background: #f0f0f0; border-radius: 20px; cursor: pointer;" onclick="copyHashtag(this)">${tag}</span>`
                ).join('');

                propertyDataDiv.innerHTML = `<em>API unavailable - using template with your property data</em>`;
                showToast('Using template content (API unavailable)', 'warning');
            }

            generateBtn.disabled = false;
            generateBtn.textContent = '‚ú® Generate AI Content';
        };

        // Fallback caption generator
        window.generateFallbackCaption = function(property, platform) {
            const address = property.address || 'Prime Location';
            const price = property.price ? `¬£${property.price}` : '';
            const beds = property.bedrooms || '';
            const baths = property.bathrooms || '';
            const type = property.propertyType || 'Property';

            if (platform === 'twitter') {
                return `üè° NEW: ${type} in ${address.split(',')[0]}${beds ? ` | ${beds} beds` : ''}${price ? ` | ${price}` : ''}\n\nDM for details or link in bio`;
            } else if (platform === 'facebook') {
                return `üè† Just Listed!\n\n${type} at ${address}\n\n${beds ? `üõèÔ∏è ${beds} Bedrooms\n` : ''}${baths ? `üöø ${baths} Bathrooms\n` : ''}${price ? `üí∞ ${price}\n` : ''}\nContact us today to arrange a viewing!\n\nüìç ${address}`;
            } else {
                // Instagram
                return `‚ú® New Listing Alert!\n\nüìç ${address}\n\n${beds ? `üõèÔ∏è ${beds} Bedrooms\n` : ''}${baths ? `üöø ${baths} Bathrooms\n` : ''}${price ? `üí∞ ${price}\n` : ''}\nDM for details or link in bio üè°`;
            }
        };

        // Dynamic hashtag generator based on property
        window.generateDynamicHashtags = function(property) {
            const hashtags = ['#NewListing', '#PropertyForSale', '#RealEstate'];

            // Add location-based hashtags
            const address = property.address || '';
            const locationParts = address.split(',');
            if (locationParts.length > 1) {
                const area = locationParts[1].trim().replace(/\s+/g, '');
                if (area && area.length > 2) {
                    hashtags.push(`#${area}Property`);
                    hashtags.push(`#${area}Homes`);
                }
            }

            // Add property type hashtags
            const type = (property.propertyType || '').toLowerCase();
            if (type.includes('detached')) hashtags.push('#DetachedHouse');
            if (type.includes('semi')) hashtags.push('#SemiDetached');
            if (type.includes('flat') || type.includes('apartment')) hashtags.push('#ApartmentForSale');
            if (type.includes('cottage')) hashtags.push('#CottageLife');
            if (type.includes('bungalow')) hashtags.push('#Bungalow');

            // Add bedroom count hashtags
            const beds = property.bedrooms;
            if (beds) {
                if (beds >= 4) hashtags.push('#FamilyHome');
                if (beds >= 5) hashtags.push('#LargeProperty');
            }

            // Add general UK property hashtags
            hashtags.push('#PropertyUK', '#HomeForSale', '#DreamHome', '#HouseHunting');

            return [...new Set(hashtags)].slice(0, 12); // Remove duplicates, max 12
        };

        // Social media helper functions
        window.selectContentType = function(type) {
            document.querySelectorAll('.content-type-btn').forEach(btn => {
                btn.style.border = '2px solid #ddd';
                btn.style.background = 'white';
            });
            event.target.closest('.content-type-btn').style.border = '2px solid #667eea';
            event.target.closest('.content-type-btn').style.background = '#f0f0ff';
        };

        window.copyCaption = function(type) {
            const textareaId = type === 'generated' ? 'captionGenerated' : ('caption' + type.charAt(0).toUpperCase() + type.slice(1));
            const textarea = document.getElementById(textareaId);
            if (textarea) {
                textarea.select();
                navigator.clipboard.writeText(textarea.value).then(() => {
                    showToast('Caption copied to clipboard!');
                }).catch(() => {
                    document.execCommand('copy');
                    showToast('Caption copied to clipboard!');
                });
            }
        };

        window.copyHashtag = function(element) {
            const text = element.textContent;
            navigator.clipboard.writeText(text);
            showToast('Copied: ' + text);
        };

        window.copyAllHashtags = function() {
            const hashtags = Array.from(document.querySelectorAll('.hashtag-chip')).map(el => el.textContent).join(' ');
            navigator.clipboard.writeText(hashtags);
            showToast('All hashtags copied!');
        };

        window.exportForInstagram = function() {
            showToast('Preparing Instagram-optimized images (1080x1080)...');
            // In production, this would resize images to Instagram specs
            setTimeout(() => showToast('Instagram pack ready!'), 1500);
        };

        window.exportForFacebook = function() {
            showToast('Preparing Facebook-optimized images (1200x628)...');
            setTimeout(() => showToast('Facebook pack ready!'), 1500);
        };

        window.downloadSocialPack = function() {
            showToast('Creating social media pack with all formats...');
            setTimeout(() => showToast('Download started!'), 2000);
        };
    </script>

    <!-- Phase 2: Professional Tools -->
    <script src="element_drag.js?v=20251231_PHASE2"></script>
    <script src="elements_library_v2.js?v=20260115_CANVA"></script>
    <script src="elements_library.js?v=20260115_CANVA_V2"></script>
    <script src="qrcode_generator.js?v=20251231_PHASE2"></script>
    <script src="layer_system.js?v=20251231_PHASE2"></script>
    <script src="alignment_system.js?v=20251231_PHASE2"></script>
    <script src="text_effects.js?v=20251231_PHASE2B"></script>
    <script src="prebuilt_sections.js?v=20251231_PHASE2B"></script>
    <script src="visual_effects.js?v=20260115_CANVA"></script>
    <script src="template_picker.js?v=20260115_CANVA"></script>
    <script src="context_menu.js?v=20260115_CANVA"></script>
    <script src="zoom_controls.js?v=20260115_CANVA"></script>
    <script src="design_elements_extended.js?v=20260115_CANVA2"></script>
    <script src="curved_text.js?v=20260115_CANVA2"></script>
    <script src="enhanced_export.js?v=20260115_CANVA2"></script>
    <script src="export_modal.js?v=20260115_MODAL"></script>
    <script src="color_picker.js?v=20260115_COLOR"></script>
    <script src="backgrounds_library.js?v=20260115_BG"></script>
    <script src="photo_frames.js?v=20260115_FRAMES"></script>
    <script src="font_loader.js?v=20260115_FONTS"></script>
    <script src="brand_kit.js?v=20260115_CANVA2"></script>
    <script src="sharing.js?v=20260115_CANVA2"></script>
    <script src="template_mega_library.js?v=20260115_MEGA"></script>
    <script src="real_templates.js?v=20260115_REAL"></script>
    <script src="template_previews.js?v=20260115_PREVIEW"></script>
    <script src="stock_photos.js?v=20260115_STOCK"></script>
    <script src="stock_photos_api.js?v=20260115_API"></script>
    <script src="icons_expanded.js?v=20260115_ICONS"></script>
    <script src="element_grouping.js?v=20260115_GROUP"></script>
    <script src="property_charts.js?v=20260115_CHARTS"></script>
    <script src="text_animations.js?v=20260115_ANIM"></script>
    <script src="british_property_badges.js?v=20260115_UK"></script>
    <script src="british_property_features.js?v=20260115_UK2"></script>

    <!-- Phase 2: Advanced Features -->
    <script src="photo_effects.js?v=20260115_EFFECTS"></script>
    <script src="background_removal.js?v=20260115_BGREM"></script>
    <script src="onboarding.js?v=20260115_ONBOARD"></script>
    <script src="keyboard_shortcuts.js?v=20260115_KEYS"></script>

    <!-- Phase 3: Pro Features -->
    <script src="magic_resize.js?v=20260116_RESIZE"></script>
    <script src="animations.js?v=20260116_ANIM"></script>
    <script src="version_history.js?v=20260116_HISTORY"></script>

    <!-- Phase 4-5: Premium Features -->
    <script src="brand_kit_v2.js?v=20260116_BRAND"></script>
    <script src="ai_content.js?v=20260116_AI"></script>
    <script src="quick_actions.js?v=20260116_QUICK"></script>

    <!-- Canva-Rival Features -->
    <script src="property_graphics.js?v=20260116_GRAPHICS"></script>
    <script src="text_styles.js?v=20260116_TEXTSTYLES"></script>
    <script src="smart_guides.js?v=20260116_GUIDES"></script>

    <!-- Initialize Phase 2 features -->
    <script>
        // Tab switching for right panels
        document.querySelectorAll('.panel-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const panelId = tab.dataset.panel;

                // Update active tab
                document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Show corresponding panel
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                const panel = document.getElementById(panelId + 'Panel');
                if (panel) panel.classList.add('active');

                // Render panel content if needed
                if (panelId === 'elements') {
                    if (typeof ElementsLibrary !== 'undefined') {
                        ElementsLibrary.render();
                    }
                    if (typeof PrebuiltSections !== 'undefined') {
                        PrebuiltSections.render();
                    }
                } else if (panelId === 'templates' && typeof TemplatePicker !== 'undefined') {
                    TemplatePicker.render('templatePickerContent');
                } else if (panelId === 'effects' && typeof VisualEffects !== 'undefined') {
                    VisualEffects.renderPanel('visualEffectsContent');
                } else if (panelId === 'layers' && typeof LayerSystem !== 'undefined') {
                    LayerSystem.render();
                }
            });
        });

        // Global Loading Spinner System
        window.LoadingSpinner = (function() {
            let overlay = null;
            let spinnerCount = 0;

            function createOverlay() {
                if (overlay) return overlay;

                overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.innerHTML = `
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading...</div>
                        <div class="loading-progress" style="display: none;">
                            <div class="progress-bar"><div class="progress-fill"></div></div>
                            <span class="progress-text">0%</span>
                        </div>
                    </div>
                `;

                const styles = document.createElement('style');
                styles.id = 'loading-spinner-styles';
                styles.textContent = `
                    #loadingOverlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.6);
                        backdrop-filter: blur(4px);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 99999;
                        opacity: 0;
                        transition: opacity 0.2s ease;
                    }
                    #loadingOverlay.visible {
                        opacity: 1;
                    }
                    .loading-content {
                        text-align: center;
                        color: white;
                    }
                    .loading-spinner {
                        width: 50px;
                        height: 50px;
                        border: 4px solid rgba(255, 255, 255, 0.3);
                        border-top-color: #FF9800;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 16px;
                    }
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                    .loading-text {
                        font-size: 16px;
                        font-weight: 500;
                        margin-bottom: 12px;
                    }
                    .loading-progress {
                        margin-top: 12px;
                    }
                    .progress-bar {
                        width: 200px;
                        height: 6px;
                        background: rgba(255, 255, 255, 0.3);
                        border-radius: 3px;
                        overflow: hidden;
                        margin: 0 auto 8px;
                    }
                    .progress-fill {
                        height: 100%;
                        background: #FF9800;
                        width: 0%;
                        transition: width 0.3s ease;
                    }
                    .progress-text {
                        font-size: 12px;
                        color: rgba(255, 255, 255, 0.8);
                    }
                `;

                if (!document.getElementById('loading-spinner-styles')) {
                    document.head.appendChild(styles);
                }
                document.body.appendChild(overlay);
                return overlay;
            }

            function show(message = 'Loading...', showProgress = false) {
                spinnerCount++;
                const el = createOverlay();
                el.querySelector('.loading-text').textContent = message;
                el.querySelector('.loading-progress').style.display = showProgress ? 'block' : 'none';
                el.style.display = 'flex';
                setTimeout(() => el.classList.add('visible'), 10);
                return { id: spinnerCount };
            }

            function hide() {
                spinnerCount = Math.max(0, spinnerCount - 1);
                if (spinnerCount === 0 && overlay) {
                    overlay.classList.remove('visible');
                    setTimeout(() => {
                        if (overlay && spinnerCount === 0) {
                            overlay.style.display = 'none';
                        }
                    }, 200);
                }
            }

            function setProgress(percent, text = null) {
                if (!overlay) return;
                const fill = overlay.querySelector('.progress-fill');
                const textEl = overlay.querySelector('.progress-text');
                if (fill) fill.style.width = percent + '%';
                if (textEl) textEl.textContent = text || (percent + '%');
            }

            function setText(message) {
                if (!overlay) return;
                const textEl = overlay.querySelector('.loading-text');
                if (textEl) textEl.textContent = message;
            }

            // Force hide all
            function forceHide() {
                spinnerCount = 0;
                if (overlay) {
                    overlay.classList.remove('visible');
                    overlay.style.display = 'none';
                }
            }

            return {
                show,
                hide,
                setProgress,
                setText,
                forceHide
            };
        })();

        // Image Drag-Drop with Visual Feedback
        function setupImageDragDrop() {
            const uploadArea = document.getElementById('imageUploadArea');
            const uploadInput = document.getElementById('imageUploadInput');
            const canvas = document.getElementById('brochure-canvas');

            if (!uploadArea || !uploadInput) return;

            // Add drag-drop styles dynamically
            const dragDropStyles = document.createElement('style');
            dragDropStyles.textContent = `
                .upload-area.drag-over {
                    background: rgba(255, 152, 0, 0.2) !important;
                    border: 2px dashed #FF9800 !important;
                    transform: scale(1.02);
                    transition: all 0.2s ease;
                }
                .upload-area.drag-over .upload-prompt {
                    background: rgba(255, 152, 0, 0.3);
                    border-radius: 8px;
                }
                .canvas-area.drag-over::before {
                    content: 'Drop image here';
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(255, 152, 0, 0.9);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 12px;
                    font-size: 18px;
                    font-weight: 600;
                    z-index: 10000;
                    pointer-events: none;
                }
                .canvas-area.drag-over {
                    position: relative;
                }
                .canvas-area.drag-over::after {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(255, 152, 0, 0.1);
                    border: 3px dashed #FF9800;
                    z-index: 9999;
                    pointer-events: none;
                }
                .photo-uploading {
                    opacity: 0.5;
                    animation: pulse 1s infinite;
                }
                @keyframes pulse {
                    0%, 100% { opacity: 0.5; }
                    50% { opacity: 0.8; }
                }
            `;
            document.head.appendChild(dragDropStyles);

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Highlight drop area when item is dragged over
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.add('drag-over');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.remove('drag-over');
                }, false);
            });

            // Handle dropped files on upload area
            uploadArea.addEventListener('drop', handleDrop, false);

            // Handle file input change
            uploadInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // Also allow dropping on canvas
            if (canvas) {
                const canvasArea = canvas.closest('.canvas-area');
                if (canvasArea) {
                    ['dragenter', 'dragover'].forEach(eventName => {
                        canvasArea.addEventListener(eventName, (e) => {
                            if (e.dataTransfer.types.includes('Files')) {
                                canvasArea.classList.add('drag-over');
                            }
                        }, false);
                    });

                    ['dragleave', 'drop'].forEach(eventName => {
                        canvasArea.addEventListener(eventName, () => {
                            canvasArea.classList.remove('drag-over');
                        }, false);
                    });

                    canvasArea.addEventListener('drop', (e) => {
                        if (e.dataTransfer.files.length > 0) {
                            handleDrop(e);
                        }
                    }, false);
                }
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }

            function handleFiles(files) {
                const imageFiles = [...files].filter(file => file.type.startsWith('image/'));

                if (imageFiles.length === 0) {
                    showNotification('Please drop image files only', 'warning');
                    return;
                }

                imageFiles.forEach((file, index) => {
                    const reader = new FileReader();

                    reader.onloadstart = () => {
                        showNotification(`Uploading ${file.name}...`, 'info');
                    };

                    reader.onload = (e) => {
                        const dataUrl = e.target.result;
                        addPhotoToGallery(dataUrl, file.name);
                        showNotification(`${file.name} uploaded successfully!`, 'success');
                    };

                    reader.onerror = () => {
                        showNotification(`Failed to upload ${file.name}`, 'error');
                    };

                    reader.readAsDataURL(file);
                });
            }

            function addPhotoToGallery(dataUrl, fileName) {
                const galleryList = document.getElementById('photoGalleryList');
                const photoCountEl = document.getElementById('photoCount');

                if (!galleryList) return;

                const photoId = 'uploaded-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

                // Store in EditorState
                if (typeof EditorState !== 'undefined') {
                    EditorState.photoUrls = EditorState.photoUrls || {};
                    EditorState.photoUrls[photoId] = dataUrl;
                }

                // Create gallery item
                const photoItem = document.createElement('div');
                photoItem.className = 'gallery-photo-item';
                photoItem.dataset.photoId = photoId;
                photoItem.draggable = true;

                photoItem.innerHTML = `
                    <img src="${dataUrl}" alt="${fileName}">
                    <div class="photo-label">${fileName}</div>
                `;

                // Allow dragging to canvas
                photoItem.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', photoId);
                    e.dataTransfer.setData('application/x-photo-url', dataUrl);
                    photoItem.classList.add('dragging');
                });

                photoItem.addEventListener('dragend', () => {
                    photoItem.classList.remove('dragging');
                });

                // Click to select
                photoItem.addEventListener('click', () => {
                    document.querySelectorAll('.gallery-photo-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    photoItem.classList.add('selected');
                    window.selectedPhotoUrl = dataUrl;
                    window.selectedPhotoId = photoId;
                });

                galleryList.appendChild(photoItem);

                // Update count
                if (photoCountEl) {
                    const count = galleryList.querySelectorAll('.gallery-photo-item').length;
                    photoCountEl.textContent = `${count} photo${count !== 1 ? 's' : ''}`;
                }
            }

            function showNotification(message, type) {
                // Create notification if doesn't exist
                let notification = document.getElementById('uploadNotification');
                if (!notification) {
                    notification = document.createElement('div');
                    notification.id = 'uploadNotification';
                    notification.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        right: 20px;
                        padding: 12px 20px;
                        border-radius: 8px;
                        color: white;
                        font-weight: 500;
                        z-index: 10001;
                        transition: opacity 0.3s ease, transform 0.3s ease;
                        transform: translateY(100px);
                        opacity: 0;
                    `;
                    document.body.appendChild(notification);
                }

                const colors = {
                    success: '#4CAF50',
                    error: '#f44336',
                    warning: '#FF9800',
                    info: '#2196F3'
                };

                notification.style.background = colors[type] || colors.info;
                notification.textContent = message;
                notification.style.transform = 'translateY(0)';
                notification.style.opacity = '1';

                setTimeout(() => {
                    notification.style.transform = 'translateY(100px)';
                    notification.style.opacity = '0';
                }, 3000);
            }

            console.log('[ImageDragDrop] Setup complete with visual feedback');
        }

        // Initialize Phase 2 features when editor is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Setup image drag-drop with visual feedback
            setupImageDragDrop();

            setTimeout(() => {
                // Render alignment toolbar
                if (typeof AlignmentSystem !== 'undefined') {
                    AlignmentSystem.renderToolbar();
                }

                // Render elements panel
                if (typeof ElementsLibrary !== 'undefined') {
                    ElementsLibrary.render();
                }

                // Render prebuilt sections
                if (typeof PrebuiltSections !== 'undefined') {
                    PrebuiltSections.render();
                }

                // Render layer panel when page changes
                const originalSelectPage = window.selectPage;
                if (originalSelectPage) {
                    window.selectPage = function(pageId) {
                        originalSelectPage(pageId);
                        if (typeof LayerSystem !== 'undefined') {
                            LayerSystem.render();
                        }
                    };
                }
            }, 1000);
        });
    </script>
</body>
</html>
